<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#000000" />>
<title>Catch Cards Memories & Tallies</title>

<style>
  body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: 'Segoe UI', sans-serif;
    background: #f2eee3; /* cork-like background */
    display: flex;
    flex-direction: column;
    color: #1b3c1a; /* dark green text */
  }

  header {
    background: #1b3c1a; /* forest green */
    color: #f7f2e3;
    padding: 1rem;
    font-weight: bold;
    text-align: center;
    font-size: 1.4rem;
    border-bottom: 4px solid #926c46; /* dark wood trim */
  }

  #tabs {
    display: flex;
    background: #2c4b1b; /* deeper forest green */
  }

  #tabs button {
    flex: 1;
    padding: 1rem;
    border: none;
    background: #d7c7a3; /* corky tab background */
    color: #1b3c1a;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  #tabs button.active {
    background: #1b3c1a; /* forest green */
    color: #fefae0;
  }

  section {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    background: #f2eee3;
  }

  /* Memories feed container */
  #photoGallery {
    max-width: 420px;
    margin: 0 auto;
    display: flex;
    flex-direction: column-reverse;
    gap: 1rem;
  }

  .catch-card {
    background: #fff8f0;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    overflow: hidden;
    max-width: 420px;
  }

  .catch-photo {
    width: 100%;
    display: block;
    cursor: pointer;
  }

  .catch-info {
    padding: 0.5rem 1rem 1rem;
  }

  .catch-caption {
    font-weight: 600;
    margin: 0.2rem 0;
  }

  .catch-location, .catch-date {
    font-size: 0.9rem;
    color: #3a3a3a;
    margin: 0.1rem 0;
  }

  .catch-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
  }

  .catch-buttons button {
    background: #4b2e1a; /* dark wood brown */
    border: none;
    color: #fdf7ee;
    padding: 0.35rem 0.8rem;
    border-radius: 6px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .catch-buttons button:hover {
    background: #60391f;
  }

  #photoInput {
    display: block;
    margin: 0 auto 1rem;
  }

  #imageModal, #instagramModal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    justify-content: center;
    align-items: center;
    z-index: 10000;
  }

  #imageModal img {
    max-width: 90vw;
    max-height: 90vh;
    border-radius: 8px;
    box-shadow: 0 0 10px #000;
  }

  .modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    font-size: 2rem;
    color: white;
    cursor: pointer;
    user-select: none;
  }

  #talliesTab h3 {
    text-align: center;
    color: #1b3c1a;
  }

  .fish-list {
    padding: 1rem;
  }

  .fish-item {
    background: #fff3dd;
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transition: transform 0.15s ease;
  }

  .fish-item:hover {
    transform: scale(1.01);
  }

  .fish-name {
    font-weight: bold;
    font-size: 1.1rem;
    cursor: pointer;
    padding-bottom: 4px;
    border-bottom: 1px solid #aaa;
    margin-bottom: 6px;
  }

  .fish-counter {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 6px 0;
  }

  .fish-counter button {
    background: #4b2e1a;
    color: white;
    border: none;
    padding: 6px 12px;
    font-size: 1.2rem;
    border-radius: 6px;
    cursor: pointer;
  }

  .fish-counter button:hover {
    background: #60391f;
  }

  .fish-counter span {
    font-size: 1.3rem;
    min-width: 30px;
    text-align: center;
  }

  .fish-tips {
    margin-top: 6px;
    font-size: 0.95rem;
    color: #333;
    display: none;
  }

  .clear-btn {
    display: block;
    margin: 10px auto;
    padding: 8px 18px;
    background: #dc2626;
    color: white;
    font-size: 1rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }

  .clear-btn:hover {
    background: #b91c1c;
  }
</style>
</head>
<body>

<header>Catch Cards App</header>

<div id="tabs">
  <button id="memoriesTabBtn" class="active">Memories</button>
  <button id="talliesTabBtn">Tallies</button>
</div>

<section id="memoriesTab">
  <input type="file" id="photoInput" accept="image/*" multiple />
  <div id="photoGallery" aria-live="polite" aria-label="Memories photo feed"></div>
</section>

<section id="talliesTab" style="display:none;">
  <h3>Fish List </h3>
  <div id="fishList" class="fish-list"></div>
<button id="clearTallies" class="clear-btn">Clear</button>
</section>

<!-- Fullscreen photo modal -->
<div id="imageModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <span id="modalClose" class="modal-close" aria-label="Close modal">&times;</span>
  <img id="modalImg" alt="Full size catch photo" />
</div>

<!-- Instagram sharing modal (simple confirmation) -->
<div id="instagramModal" role="alertdialog" aria-modal="true">
  <span id="closeInstagramModal" class="modal-close" aria-label="Close message">&times;</span>
  <div style="color:white; font-size:1.5em; background:#2563eb; padding:20px; border-radius:10px; max-width:300px; margin:auto;">
    Catch card downloaded! Share it on Instagram! ðŸ“¸
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
  // === IndexedDB Setup ===
  function openDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('MemoriesDB', 1);
      request.onupgradeneeded = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains('photos')) {
          db.createObjectStore('photos', { keyPath: 'id', autoIncrement: true });
        }
      };
      request.onsuccess = e => resolve(e.target.result);
      request.onerror = e => reject(e.target.error);
    });
  }

  async function addPhotoToDB(photo) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction('photos', 'readwrite');
      const store = tx.objectStore('photos');
      const req = store.add(photo);
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function getAllPhotosFromDB() {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction('photos', 'readonly');
      const store = tx.objectStore('photos');
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function deletePhotoFromDB(id) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction('photos', 'readwrite');
      const store = tx.objectStore('photos');
      const req = store.delete(id);
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
  }

  // Read file as data URL helper
  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = e => reject(e);
      reader.readAsDataURL(file);
    });
  }

  // Upload handler
  async function handleUpload() {
    const input = document.getElementById("photoInput");
    const files = input.files;
    if (!files.length) return;

    for (const file of files) {
      const photoSrc = await readFileAsDataURL(file);
      const location = prompt("Enter location for this photo:", "") || "";
      const caption = prompt("Enter caption for this photo:", "") || "";
      const timestamp = new Date().toISOString();

      const photoData = { src: photoSrc, caption, location, timestamp };
      await addPhotoToDB(photoData);
    }

    await cachePhotosLocally();
    input.value = "";
    renderPhotoPosts();
  }

  // Sync IndexedDB to localStorage for faster reads
  async function cachePhotosLocally() {
    const photos = await getAllPhotosFromDB();
    // Sort by timestamp ascending for consistent order (newest last)
    photos.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    localStorage.setItem('photos', JSON.stringify(photos));
  }

  // Render memories feed: newest at bottom using flex-direction: column-reverse
  function renderPhotoPosts() {
    const gallery = document.getElementById("photoGallery");
    gallery.innerHTML = "";

    const storedPhotos = JSON.parse(localStorage.getItem("photos")) || [];

    storedPhotos.forEach((photo, index) => {
      const card = document.createElement("div");
      card.className = "catch-card";

      // Photo element
      const img = document.createElement("img");
      img.src = photo.src;
      img.alt = photo.caption || "Catch photo";
      img.className = "catch-photo";
      img.addEventListener("click", () => openModal(photo.src));
      card.appendChild(img);

      // Info container
      const info = document.createElement("div");
      info.className = "catch-info";

      if (photo.caption) {
        const caption = document.createElement("p");
        caption.className = "catch-caption";
        caption.textContent = photo.caption;
        info.appendChild(caption);
      }
      if (photo.location) {
        const location = document.createElement("p");
        location.className = "catch-location";
        location.textContent = "Location: " + photo.location;
        info.appendChild(location);
      }
      if (photo.timestamp) {
        const date = document.createElement("p");
        date.className = "catch-date";
        const d = new Date(photo.timestamp);
        date.textContent = "Caught: " + d.toLocaleString();
        info.appendChild(date);
      }
      card.appendChild(info);

      // Buttons container
      const buttonRow = document.createElement("div");
      buttonRow.className = "catch-buttons";

      // Share (download) button
      const shareButton = document.createElement("button");
      shareButton.textContent = "Download";
      shareButton.title = "Download Catch Card";

      shareButton.addEventListener("click", () => {
        // Clone card and add watermark before downloading
        const clone = card.cloneNode(true);

        // Use html2canvas to capture clone element
        html2canvas(clone).then(canvas => {
          const ctx = canvas.getContext("2d");
          // Add watermark (simple text here)
          const text = "Catch Cards App";
          ctx.font = "18px Arial";
          ctx.fillStyle = "rgba(0,0,0,0.3)";
          ctx.textAlign = "right";
          ctx.fillText(text, canvas.width - 10, canvas.height - 10);

          // Download image
          const link = document.createElement("a");
          link.download = `catch-card-${index + 1}.png`;
          link.href = canvas.toDataURL("image/png");
          link.click();

          // Show Instagram modal confirmation
          openInstagramModal();
        });
      });
      buttonRow.appendChild(shareButton);

      // Delete button
      const deleteButton = document.createElement("button");
      deleteButton.textContent = "Delete";
      deleteButton.title = "Delete this photo";
      deleteButton.style.backgroundColor = "#dc2626";

      deleteButton.addEventListener("click", async () => {
        // Find photo ID from IndexedDB by matching timestamp & src (simple match)
        const photos = JSON.parse(localStorage.getItem("photos")) || [];
        const photoToDelete = photos.find(p => p.timestamp === photo.timestamp && p.src === photo.src);
        if (!photoToDelete) return;

        await deletePhotoFromDB(photoToDelete.id);
        await cachePhotosLocally();
        renderPhotoPosts();
      });
      buttonRow.appendChild(deleteButton);

      card.appendChild(buttonRow);
      gallery.appendChild(card);
    });
  }

  // Modal controls
  function openModal(src) {
    const modal = document.getElementById("imageModal");
    const modalImg = document.getElementById("modalImg");
    modalImg.src = src;
    modal.style.display = "flex";
  }
  function closeModal() {
    document.getElementById("imageModal").style.display = "none";
    document.getElementById("modalImg").src = "";
  }
  document.getElementById("modalClose").addEventListener("click", closeModal);
  window.addEventListener("keydown", e => {
    if (e.key === "Escape") closeModal();
  });

  // Instagram sharing modal controls
  function openInstagramModal() {
    const modal = document.getElementById("instagramModal");
    modal.style.display = "flex";
    setTimeout(() => {
      modal.style.display = "none";
    }, 3000);
  }
  document.getElementById("closeInstagramModal").addEventListener("click", () => {
    document.getElementById("instagramModal").style.display = "none";
  });

  // ===== Fish Data and Tally =====
// ===== Fish Data and Tally =====
const fishData = [
  { name: 'Largemouth Bass', rig: 'Texas Rig, Wacky Rig', bait: 'Plastic worms, Jigs, Crankbaits', count: 0 },
  { name: 'Smallmouth Bass', rig: 'Drop Shot', bait: 'Minnow', count: 0 },
  { name: 'Northern Pike', rig: 'Spinner Rig', bait: 'Crankbait', count: 0 },
  { name: 'Walleye', rig: 'Jig Head', bait: 'Nightcrawler', count: 0 },
  { name: 'Yellow Perch', rig: 'Slip Bobber', bait: 'Minnows', count: 0 },
  { name: 'Rainbow Trout', rig: 'Fly Rig', bait: 'Dry Fly', count: 0 },
  { name: 'Brook Trout', rig: 'Inline Spinner', bait: 'Salmon Eggs', count: 0 },
  { name: 'Lake Trout', rig: 'Downrigger', bait: 'Spoon', count: 0 },
  { name: 'Brown Trout', rig: 'Drift Rig', bait: 'Worm', count: 0 },
  { name: 'Black Crappie', rig: 'Light Jig', bait: 'Small Minnow', count: 0 },
  { name: 'White Crappie', rig: 'Micro Jig', bait: 'Grubs', count: 0 },
  { name: 'Pumpkinseed Sunfish', rig: 'Bobber Rig', bait: 'Worms', count: 0 },
  { name: 'Bluegill', rig: 'Bobber Rig', bait: 'Crickets, Worms', count: 0 },
  { name: 'Rock Bass', rig: 'Light Jig', bait: 'Minnows, Worms', count: 0 },
  { name: 'White Bass', rig: 'Spinnerbait', bait: 'Shad Imitation', count: 0 },
  { name: 'Channel Catfish', rig: 'Slip Sinker Rig', bait: 'Stinkbait, Chicken Liver', count: 0 },
  { name: 'Flathead Catfish', rig: 'Live Bait Rig', bait: 'Live Bluegill', count: 0 },
  { name: 'Blue Catfish', rig: 'Bottom Rig', bait: 'Cut Shad', count: 0 },
  { name: 'Burbot', rig: 'Glow Jig', bait: 'Cut Bait, Worms', count: 0 },
  { name: 'Bowfin', rig: 'Weedless Jig', bait: 'Live Bait, Frogs', count: 0 },
  { name: 'Carp', rig: 'Hair Rig', bait: 'Sweetcorn, Dough Balls', count: 0 },
  { name: 'Northern Sunfish', rig: 'Bobber Rig', bait: 'Worms, Insects', count: 0 },
  { name: 'Muskellunge (Muskie)', rig: 'Large Crankbait Rig, Jig', bait: 'Large Minnows, Topwater Lures', count: 0 },
  { name: 'Yellow Bullhead', rig: 'Slip Sinker Rig', bait: 'Worms, Cut Bait', count: 0 },
  { name: 'White Perch (White Bass)', rig: 'Spinnerbait, Jig', bait: 'Minnows', count: 0 },
  { name: 'Freshwater Drum', rig: 'Bottom Rig', bait: 'Worms, Small Fish', count: 0 },
  { name: 'Rainbow Smelt', rig: 'Small Jig', bait: 'Small Minnows or Flies', count: 0 },
  { name: 'Chain Pickerel', rig: 'Spinnerbait, Jig', bait: 'Minnows, Frogs', count: 0 },
  { name: 'Cisco (Lake Herring)', rig: 'Jigging Spoon', bait: 'Minnows', count: 0 },
  { name: 'Mooneye', rig: 'Fly Rig', bait: 'Small Insects, Flies', count: 0 },
  { name: 'American Eel', rig: 'Bottom Rig', bait: 'Worms, Cut Bait', count: 0 },
  { name: 'Longnose Gar', rig: 'Rope Lure', bait: 'Minnows, Live Bait', count: 0 },
  { name: 'Round Goby', rig: 'Bottom Jig', bait: 'Worms, Soft Plastics', count: 0 },
  { name: 'Spottail Shiner', rig: 'Micro Jig', bait: 'Bread, Small Insects', count: 0 },
  { name: 'Golden Shiner', rig: 'Micro Hook Rig', bait: 'Dough Balls, Worms', count: 0 }
];

// Load from localStorage
const savedFish = JSON.parse(localStorage.getItem("fishTallies"));
if (savedFish) {
  fishData.forEach((f, i) => f.count = savedFish[i]?.count || 0);
}

// Render List
function renderFishList() {
  const list = document.getElementById("fishList");
  list.innerHTML = "";

  fishData.forEach((fish, index) => {
    const item = document.createElement("div");
    item.className = "fish-item";

    const name = document.createElement("div");
    name.className = "fish-name";
    name.textContent = fish.name;
    name.addEventListener("click", () => {
      const tips = document.getElementById(`fish-tips-${index}`);
      tips.style.display = tips.style.display === "block" ? "none" : "block";
    });

    const countRow = document.createElement("div");
    countRow.className = "fish-counter";

    const minus = document.createElement("button");
    minus.textContent = "âˆ’";
    minus.addEventListener("click", () => updateCount(index, -1));

    const count = document.createElement("span");
    count.id = `count-${index}`;
    count.textContent = fish.count;

    const plus = document.createElement("button");
    plus.textContent = "+";
    plus.addEventListener("click", () => updateCount(index, 1));

    countRow.appendChild(minus);
    countRow.appendChild(count);
    countRow.appendChild(plus);

    const tips = document.createElement("div");
    tips.className = "fish-tips";
    tips.id = `fish-tips-${index}`;
    tips.innerHTML = `
      <strong>Rig:</strong> ${fish.rig}<br>
      <strong>Bait:</strong> ${fish.bait}
    `;
    tips.style.display = "none";

    item.appendChild(name);
    item.appendChild(countRow);
    item.appendChild(tips);
    list.appendChild(item);
  });
}

// Update and save
function updateCount(index, delta) {
  fishData[index].count = Math.max(0, fishData[index].count + delta);
  document.getElementById(`count-${index}`).textContent = fishData[index].count;
  localStorage.setItem("fishTallies", JSON.stringify(fishData));
}

// Clear button
function clearFishTallies() {
  if (!confirm("Clear all tallies?")) return;
  fishData.forEach(f => f.count = 0);
  localStorage.setItem("fishTallies", JSON.stringify(fishData));
  renderFishList();
}

// Init function
function initFishList() {
  renderFishList();
  const clearBtn = document.getElementById("clearTallies");
  if (clearBtn) {
    clearBtn.addEventListener("click", clearFishTallies);
  }
}

  // Tabs switching
  const memoriesTabBtn = document.getElementById("memoriesTabBtn");
  const talliesTabBtn = document.getElementById("talliesTabBtn");
  const memoriesTab = document.getElementById("memoriesTab");
  const talliesTab = document.getElementById("talliesTab");

  memoriesTabBtn.addEventListener("click", () => {
    memoriesTabBtn.classList.add("active");
    talliesTabBtn.classList.remove("active");
    memoriesTab.style.display = "";
    talliesTab.style.display = "none";
  });
  talliesTabBtn.addEventListener("click", () => {
    talliesTabBtn.classList.add("active");
    memoriesTabBtn.classList.remove("active");
    talliesTab.style.display = "";
    memoriesTab.style.display = "none";
  });

  // Init
  document.getElementById("photoInput").addEventListener("change", handleUpload);

  // On load, cache from DB -> localStorage, then render
  (async () => {
    await cachePhotosLocally();
    renderPhotoPosts();
    initFishList();
  })();

  if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('SW registered:', reg.scope))
      .catch(err => console.error('SW failed:', err));
  });
}
</script>

</body>
</html>
