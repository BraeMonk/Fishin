<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<meta name="theme-color" content="#000000" />
<title>Fishin' Buddy</title>

<style>
  /* ==== Base Reset & Layout ==== */
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f2eee3; /* cork-like warm background */
    color: #1b3c1a; /* deep forest green text */
    font-size: 1rem;
    display: flex;
    flex-direction: column;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* ==== Header ==== */
  header {
    background: #1b3c1a;
    color: #f7f2e3;
    padding: 1.1rem 1.75rem;
    font-weight: 700;
    font-size: 1.45rem;
    text-align: center;
    border-bottom: 4px solid #926c46; /* dark wood trim */
    letter-spacing: 0.04em;
    user-select: none;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    flex-shrink: 0;
  }

  /* ==== Tabs Container ==== */
  #tabs {
    display: flex;
    background: #2c4b1b;
    flex-shrink: 0;
    box-shadow: inset 0 -3px 5px rgb(0 0 0 / 0.2);
  }

  /* ==== Tab Buttons ==== */
  #tabs button {
    flex: 1;
    padding: 1rem 0.8rem;
    border: none;
    background: #d7c7a3;
    color: #1b3c1a;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.25s ease, color 0.25s ease, box-shadow 0.25s ease;
    box-shadow: inset 0 -3px 0 #a5916d;
    user-select: none;
  }
  #tabs button:hover:not(.active) {
    background-color: #c5b58b;
  }
  #tabs button.active {
    background: #1b3c1a;
    color: #fefae0;
    box-shadow: inset 0 -3px 0 #a5916d, 0 4px 8px rgb(0 0 0 / 0.15);
    font-size: 1.05rem;
  }

  /* ==== Main Content Sections ==== */
  section {
    flex: 1;
    padding: 1rem 1.25rem 1.5rem;
    background: #f2eee3;
    overflow-y: auto;
    min-height: 0; /* fix flex overflow on mobile */
    scroll-behavior: smooth;
  }

  /* ==== Buttons ==== */
  .button {
    background-color: #4b2e1e;
    color: #fff;
    padding: 0.65rem 1.1rem;
    border: none;
    border-radius: 10px;
    font-weight: 700;
    font-family: 'Verdana', sans-serif;
    box-shadow: inset 0 0 4px #00000080, 3px 3px 8px rgba(0, 0, 0, 0.35);
    cursor: pointer;
    transition:
      background-color 0.25s ease,
      transform 0.12s ease,
      box-shadow 0.15s ease;
    font-size: 1rem;
    user-select: none;
    text-shadow: 0 0 3px #2a1a10;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 1rem;
  }
  .button:hover {
    background-color: #5a3a29;
    transform: scale(1.04);
    box-shadow: inset 0 0 6px #000000cc, 4px 4px 10px rgba(0, 0, 0, 0.5);
  }
  .button:active {
    box-shadow: inset 3px 3px 10px rgba(0, 0, 0, 0.75);
    transform: scale(0.96);
  }

  .button .right-button{
    display: flex;
    gap: 0.75rem;
    align-items: centre;
  }

  /* ==== Memories Feed Container ==== */
  #photoGallery {
    max-width: 100%;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  /* ==== Catch Card ==== */
  .catch-card {
    background: #fff8f0;
    border-radius: 12px;
    box-shadow: 0 5px 12px rgba(0,0,0,0.12);
    overflow: hidden;
    max-width: 100%;
    transition: box-shadow 0.3s ease;
  }
  .catch-card:hover {
    box-shadow: 0 8px 18px rgba(0,0,0,0.2);
  }

  .catch-photo {
    width: 100%;
    display: block;
    cursor: pointer;
    border-bottom: 1px solid #d9c7b0;
    height: auto;
    border-radius: 12px 12px 0 0;
    object-fit: cover;
  }

  .catch-info {
    padding: 0.75rem 1.2rem 1.25rem;
  }

  .catch-caption {
    font-weight: 600;
    margin: 0.25rem 0;
    font-size: 1.15rem;
    color: #2e3e2f;
    letter-spacing: 0.02em;
  }

  .catch-weight {
    font-weight: 700;
    color: #4a3b2f;
    font-size: 1.05rem;
    margin-bottom: 0.3rem;
  }

  .catch-location, .catch-date {
    font-size: 0.92rem;
    color: #595959;
    margin: 0.12rem 0;
    font-style: italic;
  }

  .catch-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 0.7rem;
    padding: 0.5rem 1rem 0;
  }

  .catch-buttons button {
    background: #4b2e1a;
    border: none;
    color: #fdf7ee;
    padding: 0.4rem 0.9rem;
    border-radius: 8px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background-color 0.25s ease, box-shadow 0.25s ease;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.12);
    user-select: none;
  }
  .catch-buttons button:hover {
    background: #60391f;
    box-shadow: 0 4px 10px rgb(0 0 0 / 0.2);
  }

/* Flexible Export-style collectible trading card */
.export-style {
  max-width: 420px;      /* max width, but can shrink */
  max-height: 90vh;      /* max height relative to viewport */
  width: 90vw;           /* width scales with viewport */
  height: auto;          /* height adapts to content */
  border: 8px solid #5a432e;
  border-radius: 18px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
  font-family: 'Palatino Linotype', 'Georgia', serif;
  position: relative;
  box-sizing: border-box;
  background-color: #000; /* force black background */
  background-clip: padding-box;
  padding: 0;
  margin: 0 auto; /* center horizontally if used in flow */
  z-index: 0;
}

/* Real background layer as DOM element */
.export-style .card-background {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
  border-radius: 18px;
  z-index: 2;
  pointer-events: none;
}

/* Caption styling stays the same */
.export-style .catch-caption {
  position: absolute;
  top: 38px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 1.4rem;
  font-weight: 900;
  text-align: center;
  border-bottom: 2px solid #5a432e;
  padding-bottom: 0.3rem;
  padding-left: 1rem;
  padding-right: 1rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: #fdf8f2 !important;
  text-shadow: 1px 1px 2px #000;
  z-index: 10;
  background-color: rgba(0, 0, 0, 0.2);
  border-radius: 8px;
  margin: 0;
  max-width: 95%;
  white-space: normal;
  word-wrap: break-word;
}

/* Card number top-right */
.export-style .card-number {
  position: absolute;
  top: 10px;
  right: 14px;
  font-weight: 700;
  font-size: 1rem;
  color: #fdf8f2;
  letter-spacing: 0.15em;
  font-family: monospace, monospace;
  background: rgba(0, 0, 0, 0.6);
  padding: 0.2rem 0.4rem;
  border-radius: 6px;
  text-shadow: 1px 1px 2px #000;
  z-index: 9;
}

/* Flexible image container */
.export-style .image-window {
  position: absolute;  /* relative inside card */
  width: 85%;          /* relative to card width */
  height: 70%;    /* limit height relative to viewport */
  margin: 80px auto 20px; /* push down from caption, center horizontally */
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 0;
  transform: none;
}

/* Image scales within container */
.export-style .catch-photo {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  object-position: center;
  display: block;
  z-index: 1;
}

/* Info box near bottom */
.export-style .catch-info {
  position: absolute;                /* Changed from relative */
  bottom: 70px;                      /* Adjust based on rarity position */
  left: 50%;
  transform: translateX(-50%);
  width: 75%;

  min-height: 100px;
  
  font-size: 1.05rem;
  font-weight: 600;
  color: #fdf8f2 !important;
  text-shadow: 1px 1px 2px #000;
  text-align: left;
  background-color: rgba(0, 0, 0, 0.2);
  padding: 1rem;
  border-radius: 8px;
  border-top: 2px solid #5a432e;
  border-bottom: 2px solid #5a432e;
  display: flex;
  flex-direction: column;
  gap: 0.6rem;
  z-index: 10;
}

/* Rarity stars bottom center */
.export-style .catch-rarity {
  position: absolute;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 1.05rem;
  color: #fdf8f2;
  letter-spacing: 0.08em;
  text-shadow: 1px 1px 2px #000;
  user-select: none;
  z-index: 9;
}

/* Hide buttons when exporting */
.export-style .catch-buttons {
  display: none !important;
}

  /* ==== File Input ==== */
  #photoInput {
    display: block;
    margin: 0 auto 1rem;
    max-width: 90vw;
    width: 100%;
    border-radius: 10px;
    padding: 0.5rem;
    font-size: 1rem;
    box-shadow: inset 0 0 6px #a5916d88;
    border: 1px solid #b8a881;
    cursor: pointer;
  }
  #photoInput:hover {
    box-shadow: inset 0 0 10px #926c4611, 0 0 12px #926c46cc;
  }

  /* ==== Modals ==== */
  #imageModal, #instagramModal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.82);
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(6px);
  }

  #imageModal img {
    max-width: 90vw;
    max-height: 90vh;
    border-radius: 12px;
    box-shadow: 0 0 20px #000000bb;
    object-fit: contain;
  }

  .modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    font-size: 2.2rem;
    color: #fff;
    cursor: pointer;
    user-select: none;
    transition: color 0.3s ease;
    filter: drop-shadow(0 0 3px rgba(0,0,0,0.7));
  }
  .modal-close:hover {
    color: #d4c8b5;
  }

  /* ==== Tallies Tab ==== */
  #talliesTab h3 {
  text-align: center;
  color: #1b3c1a; /* Deep forest green */
  font-size: 1.5rem;
  font-weight: 700;
  letter-spacing: 0.04em;
  margin-bottom: 1rem;
}

.fish-list {
  padding: 1rem 0;
}

.fish-item {
  background: #fff3dd;
  border-radius: 14px;
  padding: 1rem 1.3rem;
  margin-bottom: 14px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.14);
  transition: transform 0.18s ease, box-shadow 0.18s ease;
  cursor: default;
  user-select: none;
}

.fish-item:hover {
  transform: scale(1.02);
  box-shadow: 0 6px 14px rgba(0,0,0,0.25);
}

.fish-name {
  font-weight: 700;
  font-size: 1.18rem;
  cursor: pointer;
  padding-bottom: 5px;
  border-bottom: 2px solid #b1a07a;
  margin-bottom: 0.5rem;
  color: #1b3c1a; /* Reverted to forest green */
  user-select: text;
}

.fish-counter {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 8px 0;
}

.fish-counter button {
  background: #4b2e1a;
  color: #fff;
  border: none;
  padding: 7px 14px;
  font-size: 1.25rem;
  border-radius: 8px;
  cursor: pointer;
  min-width: 3rem;
  line-height: 1;
  box-shadow: 0 2px 6px rgb(0 0 0 / 0.18);
  transition: background-color 0.3s ease;
  user-select: none;
}

.fish-counter button:hover {
  background: #60391f;
}

.fish-counter span {
  font-size: 1.35rem;
  min-width: 35px;
  text-align: center;
  color: #1b3c1a; /* Reverted from #4a4a4a to day mode green */
  font-weight: 700;
  user-select: text;
}

.fish-tips {
  margin-top: 8px;
  font-size: 1rem;
  color: #1b3c1a; /* Reverted from gray to green for visibility */
  display: none;
  font-style: italic;
  user-select: none;
}

  /* ==== Clear Button ==== */
  .clear-btn {
    display: block;
    margin: 1rem auto 0;
    padding: 10px 20px;
    background: #dc2626;
    color: #fff;
    font-size: 1.1rem;
    font-weight: 700;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    max-width: 90vw;
    width: 100%;
    box-sizing: border-box;
    box-shadow: 0 3px 8px rgb(0 0 0 / 0.25);
    transition: background-color 0.25s ease;
    user-select: none;
  }
  .clear-btn:hover {
    background: #b91c1c;
  }

  /* ==== Tab Panels ==== */
  #memoriesTab, #talliesTab, #mapTab {
    display: none;
    height: 100%;
    flex: 1;
  }
  #memoriesTab.active, #talliesTab.active, #mapTab.active {
    display: block;
    height: 100%;
    flex: 1;
  }

  /* ==== Forms ==== */
  .form-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: left;
    width: 100%;
  }

  .form-fields {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 1rem;
    max-width: 420px;
    width: 100%;
    padding: 0 1rem;
    box-sizing: border-box;
  }

  .form-fields label {
    width: 100%;
    font-weight: 700;
    font-size: 1rem;
    color: #1b3c1a;
  }

  .form-fields input[type="text"] {
    width: 100%;
    padding: 9px 12px;
    border: 1.8px solid #a89f80;
    border-radius: 8px;
    font-size: 1.05rem;
    color: #3a4a2f;
    transition: border-color 0.3s ease;
    outline-offset: 2px;
  }
  .form-fields input[type="text"]:focus {
    border-color: #4b2e1e;
    outline: none;
    box-shadow: 0 0 6px #926c4611;
  }

  .form-fields button {
    align-self: center;
  }

  .export-spinner-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.export-spinner {
  border: 8px solid #f3f3f3; /* Light grey */
  border-top: 8px solid #3498db; /* Blue */
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg);}
  100% { transform: rotate(360deg);}
}

  /* ==== Map Container ==== */
  #mapContainer {
    height: 100%;
    min-height: 320px;
    width: 100%;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgb(0 0 0 / 0.15);
    background: #eae1d5;
  }

  /* ==== Dark Mode ==== */
  body.dark-mode, html.dark-mode {
    background: #0d1b1e;
    color: #e0f7fa;
  }

  header.dark-mode {
    background: #0d1b1e;
    color: #e0f7fa;
    border-bottom: 4px solid #5e3c1f;
    box-shadow: 0 3px 8px rgb(0 0 0 / 0.35);
  }

  .dark-mode #tabs {
    background: #1a2c2c;
    box-shadow: inset 0 -3px 5px rgb(0 0 0 / 0.4);
  }

  .dark-mode #tabs button {
    background: #2c3532;
    color: #cce3dc;
    box-shadow: inset 0 -3px 0 #49735d;
  }

  .dark-mode #tabs button:hover:not(.active) {
    background-color: #3e4a48;
  }

  .dark-mode #tabs button.active {
    background: #0f2f2f;
    color: #fefae0;
    box-shadow: inset 0 -3px 0 #a48e62, 0 5px 12px rgb(0 0 0 / 0.4);
    font-size: 1.06rem;
  }

  .dark-mode section {
    background: #0d1b1e;
    color: #d1e6de;
  }

  .dark-mode .button {
    background-color: #5e3c1f;
    color: #fff;
    box-shadow: inset 0 0 3px #000, 3px 3px 8px rgba(255, 140, 0, 0.5);
  }
  .dark-mode .button:hover {
    background-color: #7a5233;
  }
  .dark-mode .button:active {
    box-shadow: inset 3px 3px 10px rgba(0, 0, 0, 0.8);
  }

  .dark-mode .catch-card {
    background: #1e2b2e;
    border: 1px solid #304f4f;
    color: #d0e6db;
  }

  .dark-mode .catch-caption,
  .dark-mode .catch-weight {
    color: #ffddaf;
  }

  .dark-mode .catch-location,
  .dark-mode .catch-date {
    color: #bcd1c9;
  }

  .dark-mode .catch-buttons button {
    background: #3f2c1f;
    color: #fdf7ee;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.3);
  }
  .dark-mode .catch-buttons button:hover {
    background: #553c2a;
  }

  .dark-mode .fish-item {
    background: #263434;
    color: #d0e6db;
    border: 1px solid #3a4c4c;
  }

  .dark-mode .fish-name {
    color: #c0dcdc;
    border-color: #c0dcdc;
  }

  .dark-mode .fish-counter span {
  color: #c0dcdc;      /* match fish tips */
}


  .dark-mode .fish-counter button {
    background: #5e3c1f;
    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  }
  .dark-mode .fish-counter button:hover {
    background: #7a5233;
  }

  .dark-mode .fish-tips {
    color: #c0dcdc;
  }

  .dark-mode .clear-btn {
    background: #8b1e1e;
    box-shadow: 0 3px 8px rgb(0 0 0 / 0.4);
  }
  .dark-mode .clear-btn:hover {
    background: #aa2a2a;
  }

  .dark-mode #imageModal,
  .dark-mode #instagramModal {
    background: rgba(0, 0, 0, 0.92);
  }

  .dark-mode #talliesTab h3 {
  color: #cce3dc;
  font-weight: 600;
  letter-spacing: 0.02em;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
}

  .dark-mode .form-fields label {
    width: 100%;
    font-weight: 700;
    font-size: 1rem;
    color: #fff;
  }

/* Smooth scrollbar for modern browsers */
section::-webkit-scrollbar {
  width: 8px;
}

section::-webkit-scrollbar-track {
  background: transparent;
}

section::-webkit-scrollbar-thumb {
  background-color: rgba(27, 60, 26, 0.4);
  border-radius: 4px;
  transition: background-color 0.3s ease;
}

section:hover::-webkit-scrollbar-thumb {
  background-color: rgba(27, 60, 26, 0.7);
}

.dark-mode section::-webkit-scrollbar-thumb {
  background-color: rgba(204, 227, 220, 0.4);
}

.dark-mode section:hover::-webkit-scrollbar-thumb {
  background-color: rgba(204, 227, 220, 0.7);
}

/* Focus outlines for accessibility */
button:focus,
input:focus {
  outline: 2px solid #926c46; /* wood trim color */
  outline-offset: 2px;
}

/* Smooth transitions for background and color changes */
body, header, #tabs button, section, .button, .catch-card, .fish-item {
  transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
}

/* Utility classes */
.text-center {
  text-align: center;
}

.mt-1 {
  margin-top: 1rem;
}

.mb-1 {
  margin-bottom: 1rem;
}

.p-1 {
  padding: 1rem;
}

/* Responsive enhancements */
@media (max-width: 320px) {
  #tabs button {
    font-size: 0.85rem;
    padding: 0.6rem 0.4rem;
  }

  header {
    font-size: 1rem;
    padding: 0.5rem 1rem;
  }
}
</style>
</head>
<body>

  <div id="darkModeContainer">
  <button id="darkModeToggle" class="button">ðŸŒ™ Toggle Night Mode</button>
</div>
<div id="right-button">
  <button id="exportToggle" class="button">Export: WebM</button>
</div>

<header>Fishin' Buddy</header>

<div id="tabs">
  <button id="memoriesTabBtn" class="active">Catch Cards</button>
  <button id="talliesTabBtn">Tallies</button>
  <button id="mapTabBtn">Map</button>
</div>

<!-- Memories Tab -->
<section id="memoriesTab" class="tab active">
  <div class="form-wrapper">
  <input type="file" id="photoInput" class="button" accept="image/*, video/*" multiple style="margin-bottom: 1rem;" />

  <div class="form-fields">
    <label for="captionInput">Name:
      <input type="text" id="captionInput" placeholder="Enter Name here" />
    </label>

    <label for="locationInput">Ability:
      <input type="text" id="locationInput" placeholder="Enter Ability here" />
    </label>

    <label for="weightInput">Weight (lbs):
      <input type="text" id="weightInput" placeholder="e.g. 2.5" />
    </label>

    <button id="uploadButton" class="button">Upload Photos</button>
  </div>

  <div id="photoGallery" aria-live="polite" aria-label="Memories photo feed" style="margin-top: 20px; width: 100%; max-width: 600px;"></div>
</div>
</section>

<!-- Tallies Tab -->
<section id="talliesTab" class="tab">
  <h3>Fish List</h3>
  <p style="font-size: 0.9em; margin-top: -10px; margin-bottom: 15px; text-align: center;">
    Bonus Tip: Tap the name of a fish to see its recommended rig and bait combos!
  </p>
  <h3>Total Fish Caught: <span id="totalFishCount">0</span></h3>
  <div id="fishList" class="fish-list"></div>
  <button id="clearTallies" class="clear-btn">Clear</button>
</section>

  <section id="mapTab" class="tab">
  <div id="map" style="height: 100%; width: 100%; min-height: 500px;"></div>
</section>

<!-- Fullscreen photo modal -->
<div id="imageModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <span id="modalClose" class="modal-close" aria-label="Close modal">&times;</span>
  <img id="modalImg" alt="Full size catch photo" />
</div>

<!-- Instagram sharing modal (simple confirmation) -->
<div id="instagramModal" role="alertdialog" aria-modal="true">
  <span id="closeInstagramModal" class="modal-close" aria-label="Close message">&times;</span>
  <div style="color:white; font-size:1.5em; background:#2563eb; padding:20px; border-radius:10px; max-width:300px; margin:auto;">
    Catch card downloaded! Share it on Instagram! ðŸ“¸
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
  <!-- Whammy.js -->
<script src="https://cdn.jsdelivr.net/npm/whammy/whammy.js"></script>
<script>
  let useWhammy = true;
  
  function setupTabs() {
  const memoriesTabBtn = document.getElementById("memoriesTabBtn");
  const talliesTabBtn = document.getElementById("talliesTabBtn");
  const mapTabBtn = document.getElementById("mapTabBtn"); // new

  const memoriesTab = document.getElementById("memoriesTab");
  const talliesTab = document.getElementById("talliesTab");
  const mapTab = document.getElementById("mapTab"); // new

  if (!memoriesTabBtn || !talliesTabBtn || !mapTabBtn || !memoriesTab || !talliesTab || !mapTab) {
    console.warn("One or more tab elements are missing.");
    return;
  }

  memoriesTabBtn.addEventListener("click", () => {
    memoriesTabBtn.classList.add("active");
    talliesTabBtn.classList.remove("active");
    mapTabBtn.classList.remove("active");

    memoriesTab.classList.add("active");
    talliesTab.classList.remove("active");
    mapTab.classList.remove("active");
  });

  talliesTabBtn.addEventListener("click", () => {
    talliesTabBtn.classList.add("active");
    memoriesTabBtn.classList.remove("active");
    mapTabBtn.classList.remove("active");

    talliesTab.classList.add("active");
    memoriesTab.classList.remove("active");
    mapTab.classList.remove("active");
  });

  mapTabBtn.addEventListener("click", () => {
    mapTabBtn.classList.add("active");
    memoriesTabBtn.classList.remove("active");
    talliesTabBtn.classList.remove("active");

    mapTab.classList.add("active");
    memoriesTab.classList.remove("active");
    talliesTab.classList.remove("active");

    // Fix Leaflet map rendering after tab is shown
    setTimeout(() => {
      if (window.myMap) {
        window.myMap.invalidateSize();
      }
    }, 200);
  });
}
  
  // === IndexedDB Setup ===
  function openDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('MemoriesDB', 1);
      request.onupgradeneeded = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains('photos')) {
          db.createObjectStore('photos', { keyPath: 'id', autoIncrement: true });
        }
      };
      request.onsuccess = e => resolve(e.target.result);
      request.onerror = e => reject(e.target.error);
    });
  }

  async function addPhotoToDB(photo) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction('photos', 'readwrite');
      const store = tx.objectStore('photos');
      const req = store.add(photo);
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function getAllPhotosFromDB() {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction('photos', 'readonly');
      const store = tx.objectStore('photos');
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function deletePhotoFromDB(id) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction('photos', 'readwrite');
      const store = tx.objectStore('photos');
      const req = store.delete(id);
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
  }

  // Read file as data URL helper
  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = e => reject(e);
      reader.readAsDataURL(file);
    });
  }

  async function handleUpload() {
  const input = document.getElementById("photoInput");
  const files = input.files;
  if (!files.length) {
    alert("Please select at least one photo to upload.");
    return;
  }

  const caption = document.getElementById("captionInput").value.trim();
  const location = document.getElementById("locationInput").value.trim();
  const weight = document.getElementById("weightInput").value.trim();

  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    const fileType = file.type;

    // Allow images, gifs, and videos
    if (
      !fileType.startsWith("image/") &&
      !fileType.startsWith("video/")
    ) continue;

    try {
      const dataURL = await readFileAsDataURL(file);
      const timestamp = new Date().toISOString();

      const photoData = {
        caption,
        location,
        weight,
        timestamp,
        name: file.name,
        type: fileType,
      };

      // Store appropriately based on media type
      if (fileType.startsWith("video/")) {
        photoData.videoSrc = dataURL;
        photoData.src = ""; // optional fallback
      } else if (fileType.startsWith("image/")) {
        photoData.src = dataURL; // includes gifs, png, jpg, etc.
      }

      const id = await addPhotoToDB(photoData);
      photoData.id = id;

      renderSinglePhoto(photoData);
    } catch (error) {
      console.error("Failed to process file:", error);
    }
  }

  // Optional: Clear form
  input.value = "";
  document.getElementById("captionInput").value = "";
  document.getElementById("locationInput").value = "";
  document.getElementById("weightInput").value = "";
}

  function renderSinglePhoto(photo) {
  const gallery = document.getElementById("photoGallery");

  const card = document.createElement("div");
  card.className = "catch-card";

  const img = document.createElement("img");
  img.src = photo.src;
  img.alt = photo.caption || "Catch photo";
  img.className = "catch-photo";
  img.addEventListener("click", () => openModal(photo.src));
  card.appendChild(img);

  const info = document.createElement("div");
  info.className = "catch-info";

  if (photo.caption) {
    const cap = document.createElement("p");
    cap.className = "catch-caption";
    cap.textContent = photo.caption;
    info.appendChild(cap);
  }

  if (photo.location) {
    const loc = document.createElement("p");
    loc.className = "catch-location";
    loc.textContent = "Ability: " + photo.location;
    info.appendChild(loc);
  }

  if (photo.timestamp) {
    const dt = document.createElement("p");
    dt.className = "catch-date";
    dt.textContent = "Caught: " + new Date(photo.timestamp).toLocaleString();
    info.appendChild(dt);
  }

  if (photo.weight) {
    const wt = document.createElement("p");
    wt.className = "catch-weight";
    wt.textContent = "Weight: " + photo.weight + " lbs";
    info.appendChild(wt);
  }

  card.appendChild(info);

  const buttonRow = document.createElement("div");
  buttonRow.className = "catch-buttons";

  const deleteButton = document.createElement("button");
  deleteButton.textContent = "Delete";
  deleteButton.addEventListener("click", async () => {
    if (confirm("Delete this photo?")) {
      await deletePhotoFromDB(photo.id);
      await renderPhotoPosts(); // Refresh gallery
    }
  });
  buttonRow.appendChild(deleteButton);

  const shareButton = document.createElement("button");
  shareButton.textContent = "Catch Card";
  shareButton.addEventListener("click", () => {
    // Automatically pick the right export method based on file type
    const isGif =
  (photo.type && photo.type === "image/gif") ||
  (photo.name && photo.name.toLowerCase().endsWith(".gif")) ||
  photo.src.toLowerCase().includes(".gif") ||
  photo.src.toLowerCase().includes("image/gif");
    if (isGif) {
      exportCatchCardAsGif(card, photo); // animated export
    } else {
      exportCatchCard(card, photo); // static PNG export
    }
  });
  buttonRow.appendChild(shareButton);

  card.appendChild(buttonRow);

  // ðŸ‘‡ Add new photo to the top of the gallery
gallery.prepend(card);

// ðŸ‘‡ Smooth scroll the new card into view
card.scrollIntoView({ behavior: "smooth", block: "start" });
}
  
async function renderPhotoPosts() {
  const gallery = document.getElementById("photoGallery");
  gallery.innerHTML = "";

  const photos = await getAllPhotosFromDB();
  photos.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

  photos.forEach(photo => {
    const card = document.createElement("div");
    card.className = "catch-card";

    let mediaElement;

    if (photo.videoSrc) {
      mediaElement = document.createElement("video");
      mediaElement.muted = true;
      mediaElement.src = photo.videoSrc;
      mediaElement.autoplay = true;   // autoplay on load
      mediaElement.loop = true;       // loop forever
      mediaElement.playsInline = true; // important for mobile autoplay
      mediaElement.className = "catch-photo";
      mediaElement.addEventListener("click", () => openModal(photo.videoSrc));
    } else if (photo.src) {
      mediaElement = document.createElement("img");
      mediaElement.src = photo.src;
      mediaElement.alt = photo.caption || "Catch photo";
      mediaElement.className = "catch-photo";
      mediaElement.addEventListener("click", () => openModal(photo.videoSrc || photo.src));
    }

    if (mediaElement) card.appendChild(mediaElement);

    const info = document.createElement("div");
    info.className = "catch-info";

    if (photo.caption) {
      const cap = document.createElement("p");
      cap.className = "catch-caption";
      cap.textContent = photo.caption;
      info.appendChild(cap);
    }
    if (photo.location) {
      const loc = document.createElement("p");
      loc.className = "catch-location";
      loc.textContent = "Ability: " + photo.location;
      info.appendChild(loc);
    }
    if (photo.timestamp) {
      const dt = document.createElement("p");
      dt.className = "catch-date";
      dt.textContent = "Caught: " + new Date(photo.timestamp).toLocaleString();
      info.appendChild(dt);
    }
    if (photo.weight) {
      const wt = document.createElement("p");
      wt.className = "catch-weight";
      wt.textContent = "Weight: " + photo.weight + " lbs";
      info.appendChild(wt);
    }
    card.appendChild(info);

    const buttonRow = document.createElement("div");
    buttonRow.className = "catch-buttons";

    const deleteButton = document.createElement("button");
    deleteButton.textContent = "Delete";
    deleteButton.addEventListener("click", async (event) => {
      event.stopPropagation(); // ðŸ”’ prevent modal from opening
      if (confirm("Delete this photo?")) {
        await deletePhotoFromDB(photo.id);
        await renderPhotoPosts();
      }
    });
    buttonRow.appendChild(deleteButton);

    const shareButton = document.createElement("button");
    shareButton.textContent = "Catch Card";
    shareButton.addEventListener("click", (event) => {
      event.stopPropagation(); // ðŸ”’ prevents modal from opening

      const isGif =
        (photo.type && photo.type === "image/gif") ||
        (photo.name && photo.name.toLowerCase().endsWith(".gif")) ||
        photo.src.toLowerCase().includes(".gif") ||
        photo.src.toLowerCase().includes("image/gif");

      if (isGif) {
        exportCatchCardAsGif(card, photo);
      } else {
        exportCatchCard(card, photo);
      }
    });
    buttonRow.appendChild(shareButton);

    card.appendChild(buttonRow);

    gallery.appendChild(card);
  });  // End of forEach

} // End of renderPhotoPosts

function exportCatchCardSmart(card, photo) {
  const imgElem = card.querySelector(".catch-photo");
  const src = imgElem?.src || photo?.src || "";

  const isGif =
    src.startsWith("data:image/gif") ||
    /\.gif$/i.test(src) ||
    (photo.src && photo.src.includes("gif"));

  const isVideo =
    src.startsWith("data:video") ||
    /\.(webm|mp4|mov)$/i.test(src) ||
    (photo.videoSrc && /\.(webm|mp4|mov)$/i.test(photo.videoSrc));

  if (isGif) {
    if (useGifJs) {
      exportCatchCardAsGif(card, photo); // gif.js path
    } else {
      exportCatchCardAsVideo(card, photo, src); // fallback to video path
    }
  } else if (isVideo) {
    exportCatchCardAsVideo(card, photo, photo.videoSrc || src); // <-- call the real deal
  } else {
    exportCatchCardAsImage(card, photo); // static PNG
  }
}

// 2. Your original exportCatchCard logic, wrapped into exportCatchCardAsImage:
function exportCatchCardAsImage(card, photo) {
  const clone = card.cloneNode(true);
  clone.classList.add("export-style");
  clone.style.width = "420px";
  clone.style.height = "620px";

  // Background and rarity logic
  const bg = document.createElement("div");
  bg.className = "card-background";
  const backgroundMap = {
    1: "./Background.png",
    2: "./Background-2.png",
    3: "./Background-3.png",
    4: "./Background-4.png",
    5: "./Background-5.png"
  };
  const starsCount = Math.floor(Math.random() * 5) + 1;
  const rarity = document.createElement("div");
  rarity.className = "catch-rarity";
  rarity.textContent = "â˜…".repeat(starsCount) + "â˜†".repeat(5 - starsCount);
  clone.appendChild(rarity);
  clone.classList.add(`rarity-${starsCount}`);
  bg.style.backgroundImage = `url('${backgroundMap[starsCount]}')`;
  clone.insertBefore(bg, clone.firstChild);

  // Remove buttons
  const buttons = clone.querySelector(".catch-buttons");
  if (buttons) buttons.remove();

  // Replace photo with image-window wrapper
  const originalImg = clone.querySelector(".catch-photo");
  const imageWrapper = document.createElement("div");
  imageWrapper.className = "image-window";
  imageWrapper.appendChild(originalImg.cloneNode(true));
  originalImg.parentNode.replaceChild(imageWrapper, originalImg);

  const insertedImg = imageWrapper.querySelector("img");
  insertedImg.className = "catch-photo";
  insertedImg.removeAttribute("style");

  // Move caption above info
  const caption = clone.querySelector(".catch-caption");
  const info = clone.querySelector(".catch-info");
  if (caption && info && info.contains(caption)) {
    info.removeChild(caption);
    clone.insertBefore(caption, info);
  }

  // Remove unneeded info
  const weight = clone.querySelector(".catch-weight");
  if (weight) weight.remove();
  const date = clone.querySelector(".catch-date");
  if (date) date.remove();

  // Add card number
  const cardNumber = document.createElement("div");
  cardNumber.className = "card-number";
  cardNumber.textContent = `#${String(photo.id).padStart(3, "0")}`;
  clone.appendChild(cardNumber);

  // Add to hidden rendering container
  const renderContainer = document.createElement("div");
  renderContainer.style.position = "absolute";
  renderContainer.style.top = "-9999px";
  renderContainer.style.left = "0";
  renderContainer.style.width = "420px";
  renderContainer.style.height = "620px";
  renderContainer.appendChild(clone);
  document.body.appendChild(renderContainer);

  function renderCard() {
    html2canvas(clone, {
      width: clone.offsetWidth,
      height: clone.offsetHeight,
      scrollX: 0,
      scrollY: 0,
      backgroundColor: null,
      useCORS: true,
    }).then((canvas) => {
      const ctx = canvas.getContext("2d");
      const watermarkImg = new Image();
      watermarkImg.src = "./icon_192x192.png";

      watermarkImg.onload = () => {
        ctx.globalAlpha = 1;
        const size = 64;
        const padding = 10;

        ctx.drawImage(
          watermarkImg,
          canvas.width - size - padding,
          canvas.height - size - padding,
          size,
          size
        );

        const link = document.createElement("a");
        link.download = `catch-card-${photo.id}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();

        renderContainer.remove();
      };
    });
  }

  const imgToLoad = clone.querySelector(".catch-photo");
  if (imgToLoad && !imgToLoad.complete) {
    imgToLoad.onload = renderCard;
    imgToLoad.onerror = renderCard;
  } else {
    renderCard();
  }
}

  function showExportSpinner() {
  const spinner = document.createElement("div");
  spinner.className = "export-spinner-overlay";
  spinner.innerHTML = `<div class="export-spinner"></div>`;
  document.body.appendChild(spinner);
}

function hideExportSpinner() {
  const spinner = document.querySelector(".export-spinner-overlay");
  if (spinner) spinner.remove();
}

async function exportCatchCardAsGif(card, photo) {
  showExportSpinner();

  const clone = card.cloneNode(true);
  clone.classList.add("export-style");
  clone.style.width = "420px";
  clone.style.height = "620px";

  // Offscreen container
  const renderContainer = document.createElement("div");
  renderContainer.style.position = "absolute";
  renderContainer.style.top = "-9999px";
  renderContainer.style.left = "0";
  renderContainer.style.width = "420px";
  renderContainer.style.height = "620px";
  renderContainer.appendChild(clone);
  document.body.appendChild(renderContainer);

  const gif = new GIF({
    workers: 1,
    quality: 5,
    width: 420,
    height: 620,
    workerScript: "https://cdn.jsdelivr.net/npm/gif.js.optimized@0.2.0/dist/gif.worker.js",
  });

  const frameCount = 10;
  const frameDelay = 100;

  gif.on("finished", function (blob) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `catch-card-${photo.id}.gif`;
    a.click();
    URL.revokeObjectURL(url);
    renderContainer.remove();
    hideExportSpinner();
  });

  try {
    for (let i = 0; i < frameCount; i++) {
      const canvas = await html2canvas(clone, {
        width: clone.offsetWidth,
        height: clone.offsetHeight,
        scrollX: 0,
        scrollY: 0,
        backgroundColor: null,
        scale: 2,
        useCORS: true,
      });

      gif.addFrame(canvas, { delay: frameDelay });
      await new Promise((res) => setTimeout(res, frameDelay));
    }

    gif.render();

  } catch (err) {
    alert("GIF export failed: " + err.message);
    renderContainer.remove();
    hideExportSpinner();
  }
}

  async function exportCatchCardAsVideo(card, photo, videoSrc) {
  const clone = card.cloneNode(true);
  clone.classList.add("export-style");
  clone.style.width = "420px";
clone.style.height = "620px";

  // Remove buttons
  const buttons = clone.querySelector(".catch-buttons");
  if (buttons) buttons.remove();

  // Background & rarity stars
  const bg = document.createElement("div");
  bg.className = "card-background";
  const backgroundMap = {
    1: "./Background.png",
    2: "./Background-2.png",
    3: "./Background-3.png",
    4: "./Background-4.png",
    5: "./Background-5.png",
  };
  const starsCount = photo.rarity || Math.floor(Math.random() * 5) + 1;
  const rarity = document.createElement("div");
  rarity.className = "catch-rarity";
  rarity.textContent = "â˜…".repeat(starsCount) + "â˜†".repeat(5 - starsCount);
  clone.appendChild(rarity);
  clone.classList.add(`rarity-${starsCount}`);
  bg.style.backgroundImage = `url('${backgroundMap[starsCount]}')`;
  clone.insertBefore(bg, clone.firstChild);

  // Replace image with video element inside image-window wrapper
  const originalImg = clone.querySelector(".catch-photo");
  const imageWrapper = document.createElement("div");
  imageWrapper.className = "image-window";

  const video = document.createElement("video");
  video.src = videoSrc;
  video.autoplay = true;
  video.loop = true;
  video.muted = true;
  video.style.width = "100%";
  video.style.height = "100%";
  video.style.objectFit = "contain";

  imageWrapper.appendChild(video);
  originalImg.parentNode.replaceChild(imageWrapper, originalImg);

  // Caption above info
  const caption = clone.querySelector(".catch-caption");
  const info = clone.querySelector(".catch-info");
  if (caption && info && info.contains(caption)) {
    info.removeChild(caption);
    clone.insertBefore(caption, info);
  }

  // Remove weight and date for cleaner card
  const weight = clone.querySelector(".catch-weight");
  if (weight) weight.remove();
  const date = clone.querySelector(".catch-date");
  if (date) date.remove();

  // Add card number
  const cardNumber = document.createElement("div");
  cardNumber.className = "card-number";
  cardNumber.textContent = `#${String(photo.id).padStart(3, "0")}`;
  clone.appendChild(cardNumber);

  // Offscreen container for rendering
  const renderContainer = document.createElement("div");
  renderContainer.style.position = "absolute";
  renderContainer.style.top = "-9999px";
  renderContainer.style.left = "0";
  renderContainer.style.width = "420px";
  renderContainer.style.height = "620px";
  renderContainer.appendChild(clone);
  document.body.appendChild(renderContainer);

  // Prepare Whammy video encoder (10fps)
  const encoder = new Whammy.Video(10);

  // Wait for video to start playing to capture frames
  await new Promise((resolve) => {
    video.onplaying = resolve;
    // In case already playing
    if (!video.paused) resolve();
  });

  const frameCount = 10;
  const frameDelay = 100; // ms

  for (let i = 0; i < frameCount; i++) {
    const canvasFrame = await html2canvas(clone, {
      width: clone.offsetWidth,
      height: clone.offsetHeight,
      scrollX: 0,
      scrollY: 0,
      backgroundColor: null,
      scale: 2,
    });

    encoder.add(canvasFrame);
    await new Promise((r) => setTimeout(r, frameDelay));
  }

  // Compile video and trigger download
  const output = encoder.compile();
  const url = URL.createObjectURL(output);
  const a = document.createElement("a");
  a.href = url;
  a.download = `catch-card-${photo.id}.webm`;
  a.click();
  URL.revokeObjectURL(url);

  renderContainer.remove();
}

async function exportCatchCard(card, photo, recordDurationMs = 5000, useWhammy = true) {
  const clone = card.cloneNode(true);
  clone.classList.add("export-style");
  clone.style.width = "420px";
  clone.style.height = "620px";

  // Background & rarity setup
  const bg = document.createElement("div");
  bg.className = "card-background";
  const backgroundMap = {
    1: "./Background.png",
    2: "./Background-2.png",
    3: "./Background-3.png",
    4: "./Background-4.png",
    5: "./Background-5.png",
  };
  const starsCount = photo.rarity || Math.floor(Math.random() * 5) + 1;
  const rarity = document.createElement("div");
  rarity.className = "catch-rarity";
  rarity.textContent = "â˜…".repeat(starsCount) + "â˜†".repeat(5 - starsCount);
  clone.appendChild(rarity);
  clone.classList.add(`rarity-${starsCount}`);
  bg.style.backgroundImage = `url('${backgroundMap[starsCount]}')`;
  clone.insertBefore(bg, clone.firstChild);

  // Remove buttons
  const buttons = clone.querySelector(".catch-buttons");
  if (buttons) buttons.remove();

  // Wrap media (image or video) inside image-window
  let mediaElement = clone.querySelector(".catch-photo");
  const imageWrapper = document.createElement("div");
  imageWrapper.className = "image-window";

  if (mediaElement.tagName === "VIDEO") {
    const videoClone = mediaElement.cloneNode(true);
    videoClone.muted = true;
    videoClone.loop = true;
    videoClone.autoplay = true;
    videoClone.controls = false;
    imageWrapper.appendChild(videoClone);
  } else {
    imageWrapper.appendChild(mediaElement.cloneNode(true));
  }
  mediaElement.parentNode.replaceChild(imageWrapper, mediaElement);

  // Clean up inserted image styles if image exists
  const insertedImg = imageWrapper.querySelector("img");
  if (insertedImg) {
    insertedImg.className = "catch-photo";
    insertedImg.removeAttribute("style");
  }

  // Reposition caption above info
  const caption = clone.querySelector(".catch-caption");
  const info = clone.querySelector(".catch-info");
  if (caption && info && info.contains(caption)) {
    info.removeChild(caption);
    clone.insertBefore(caption, info);
  }

  // Remove weight and date
  const weight = clone.querySelector(".catch-weight");
  if (weight) weight.remove();
  const date = clone.querySelector(".catch-date");
  if (date) date.remove();

  // Add card number
  const cardNumber = document.createElement("div");
  cardNumber.className = "card-number";
  cardNumber.textContent = `#${String(photo.id).padStart(3, "0")}`;
  clone.appendChild(cardNumber);

  // Offscreen container for rendering (must be in DOM for video playback)
  const renderContainer = document.createElement("div");
  renderContainer.style.position = "absolute";
  renderContainer.style.top = "-9999px";
  renderContainer.style.left = "0";
  renderContainer.style.width = "420px";
  renderContainer.style.height = "620px";
  renderContainer.style.overflow = "hidden";
  renderContainer.appendChild(clone);
  document.body.appendChild(renderContainer);

  // Find video inside clone if any
  const video = clone.querySelector("video.catch-photo");

  if (video) {
    // Wait for video to be ready and playing
    await new Promise((resolve, reject) => {
      function onPlay() {
        video.removeEventListener("playing", onPlay);
        resolve();
      }
      video.addEventListener("playing", onPlay);
      video.play().catch(reject);
    });

    // Load background image once
    let bgImg = null;
    const bgDiv = clone.querySelector(".card-background");
    if (bgDiv) {
      const bgStyle = window.getComputedStyle(bgDiv).backgroundImage;
      const urlMatch = bgStyle.match(/url\(["']?(.+?)["']?\)/);
      if (urlMatch) {
        bgImg = new Image();
        bgImg.src = urlMatch[1];
        await new Promise((res) => {
          if (bgImg.complete) res();
          else bgImg.onload = res;
          bgImg.onerror = res; // fallback on error
        });
      }
    }

    const canvas = document.createElement("canvas");
    canvas.width = 420 * 2; // 2x scale for quality
    canvas.height = 620 * 2;
    const ctx = canvas.getContext("2d");
    ctx.scale(2, 2);

    const stream = canvas.captureStream(30); // 30fps
    const recordedChunks = [];
    const mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });

    mediaRecorder.ondataavailable = (event) => {
      if (event.data.size > 0) recordedChunks.push(event.data);
    };

    const startTime = performance.now();

    mediaRecorder.start();

    function drawFrame() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw background once loaded
      if (bgImg && bgImg.complete) {
        ctx.drawImage(bgImg, 0, 0, 420, 620);
      } else {
        ctx.fillStyle = "#222";
        ctx.fillRect(0, 0, 420, 620);
      }

      // Draw video frame approx in .image-window area
      const videoX = 10;
      const videoY = 100;
      const videoW = 400;
      const videoH = 300;
      ctx.drawImage(video, videoX, videoY, videoW, videoH);

      // Draw rarity stars
      const rarityDiv = clone.querySelector(".catch-rarity");
      if (rarityDiv) {
        ctx.font = "28px serif";
        ctx.fillStyle = "gold";
        ctx.textBaseline = "top";
        ctx.fillText(rarityDiv.textContent, 10, 20);
      }

      // Draw caption
      const captionDiv = clone.querySelector(".catch-caption");
      if (captionDiv) {
        ctx.font = "20px sans-serif";
        ctx.fillStyle = "white";
        ctx.textBaseline = "top";
        ctx.fillText(captionDiv.textContent, 10, 420);
      }

      // Draw card number
      const cardNumDiv = clone.querySelector(".card-number");
      if (cardNumDiv) {
        ctx.font = "16px monospace";
        ctx.fillStyle = "white";
        ctx.textBaseline = "bottom";
        ctx.fillText(cardNumDiv.textContent, 350, 610);
      }
    }

    return new Promise((resolve) => {
      function renderLoop() {
        drawFrame();
        if (performance.now() - startTime < recordDurationMs) {
          requestAnimationFrame(renderLoop);
        } else {
          mediaRecorder.stop();
        }
      }

      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `catch-card-${photo.id}.webm`;
        a.click();

        URL.revokeObjectURL(url);
        renderContainer.remove();
        resolve();
      };

      renderLoop();
    });
  } else {
    // No video â€” fallback to PNG or GIF export

    const insertedImg = clone.querySelector(".catch-photo");
    const imgSrc = insertedImg ? insertedImg.src.toLowerCase() : "";
    const isGif = imgSrc.endsWith(".gif") || imgSrc.includes("image/gif");

    if (!isGif) {
      // PNG export
      try {
        const canvas = await html2canvas(clone, {
          width: clone.offsetWidth,
          height: clone.offsetHeight,
          scrollX: 0,
          scrollY: 0,
          backgroundColor: null,
          scale: 2,
          useCORS: true,
        });

        const ctx = canvas.getContext("2d");
        const watermarkImg = new Image();
        watermarkImg.src = "./icon_192x192.png";
        await new Promise((res) => {
          watermarkImg.onload = res;
        });
        const size = 64,
          padding = 10;
        ctx.globalAlpha = 1;
        ctx.drawImage(
          watermarkImg,
          canvas.width - size - padding,
          canvas.height - size - padding,
          size,
          size
        );

        const link = document.createElement("a");
        link.download = `catch-card-${photo.id}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
      } catch (e) {
        alert("Failed to export PNG: " + e.message);
      } finally {
        renderContainer.remove();
      }
    } else {
      // Animated GIF export path
      try {
        if (useWhammy) {
          const encoder = new Whammy.Video(10); // 10fps
          for (let i = 0; i < 10; i++) {
            const canvasFrame = await html2canvas(clone, {
              width: clone.offsetWidth,
              height: clone.offsetHeight,
              scrollX: 0,
              scrollY: 0,
              backgroundColor: null,
              scale: 2,
            });

            encoder.add(canvasFrame);
            await new Promise((r) => setTimeout(r, 100));
          }

          const output = encoder.compile();
          const url = URL.createObjectURL(output);
          const a = document.createElement("a");
          a.href = url;
          a.download = `catch-card-${photo.id}.webm`;
          a.click();
          URL.revokeObjectURL(url);
        } else {
          const gif = new GIF({
            workers: 2,
            quality: 10,
            width: 420 * 2,
            height: 620 * 2,
          });

          for (let i = 0; i < 10; i++) {
            const canvasFrame = await html2canvas(clone, {
              width: clone.offsetWidth,
              height: clone.offsetHeight,
              scrollX: 0,
              scrollY: 0,
              backgroundColor: null,
              scale: 2,
            });

            gif.addFrame(canvasFrame, { delay: 100 });
            await new Promise((r) => setTimeout(r, 100));
          }

          gif.on("finished", function (blob) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `catch-card-${photo.id}.gif`;
            a.click();
            URL.revokeObjectURL(url);
            renderContainer.remove();
          });

          gif.render();
          return; // early exit as gif finishes async
        }
      } catch (e) {
        alert("Failed to export animation: " + e.message);
      } finally {
        renderContainer.remove();
      }
    }
  }
}
  
function openModal(src) {
  const modal = document.getElementById("imageModal");
  const modalImg = document.getElementById("modalImg");

  // Check file extension for video or gif
  const isVideo = src.match(/\.(mp4|webm|ogg)$/i);
  const isGif = src.match(/\.gif$/i);

  if (isVideo) {
    // Handle video
    let video = document.getElementById("modalVideo");
    if (!video) {
      video = document.createElement("video");
      video.id = "modalVideo";
      video.controls = true;
      video.autoplay = true;
      video.loop = true;
      video.muted = false; // or true if you want muted by default
      video.style.maxWidth = "100%";
      video.style.maxHeight = "100%";

      modalImg.style.display = "none";
      modal.appendChild(video);
    }
    video.src = src;
    video.style.display = "block";

  } else {
    // Handle image or GIF (both displayed as <img>)
    modalImg.src = src;
    modalImg.style.display = "block";

    const video = document.getElementById("modalVideo");
    if (video) {
      video.pause();
      video.style.display = "none";
      video.src = "";
    }
  }

  modal.style.display = "flex";
}

function closeModal() {
  const modal = document.getElementById("imageModal");
  modal.style.display = "none";

  const video = document.getElementById("modalVideo");
  if (video) {
    video.muted = true;
    video.pause();
    video.currentTime = 0;
  }
}

  const fishData = [
    { name: 'Largemouth Bass', rig: 'Texas Rig, Wacky Rig', bait: 'Plastic worms, Jigs, Crankbaits', count: 0 },
    { name: 'Smallmouth Bass', rig: 'Drop Shot', bait: 'Minnow', count: 0 },
    { name: 'Northern Pike', rig: 'Spinner Rig', bait: 'Crankbait', count: 0 },
    { name: 'Walleye', rig: 'Jig Head', bait: 'Nightcrawler', count: 0 },
    { name: 'Yellow Perch', rig: 'Slip Bobber', bait: 'Minnows', count: 0 },
    { name: 'Rainbow Trout', rig: 'Fly Rig', bait: 'Dry Fly', count: 0 },
    { name: 'Brook Trout', rig: 'Inline Spinner', bait: 'Salmon Eggs', count: 0 },
    { name: 'Lake Trout', rig: 'Downrigger', bait: 'Spoon', count: 0 },
    { name: 'Brown Trout', rig: 'Drift Rig', bait: 'Worm', count: 0 },
    { name: 'Black Crappie', rig: 'Light Jig', bait: 'Small Minnow', count: 0 },
    { name: 'White Crappie', rig: 'Micro Jig', bait: 'Grubs', count: 0 },
    { name: 'Pumpkinseed Sunfish', rig: 'Bobber Rig', bait: 'Worms', count: 0 },
    { name: 'Bluegill', rig: 'Bobber Rig', bait: 'Crickets, Worms', count: 0 },
    { name: 'Rock Bass', rig: 'Light Jig', bait: 'Minnows, Worms', count: 0 },
    { name: 'White Bass', rig: 'Spinnerbait', bait: 'Shad Imitation', count: 0 },
    { name: 'Channel Catfish', rig: 'Slip Sinker Rig', bait: 'Stinkbait, Chicken Liver', count: 0 },
    { name: 'Flathead Catfish', rig: 'Live Bait Rig', bait: 'Live Bluegill', count: 0 },
    { name: 'Blue Catfish', rig: 'Bottom Rig', bait: 'Cut Shad', count: 0 },
    { name: 'Burbot', rig: 'Glow Jig', bait: 'Cut Bait, Worms', count: 0 },
    { name: 'Bowfin', rig: 'Weedless Jig', bait: 'Live Bait, Frogs', count: 0 },
    { name: 'Carp', rig: 'Hair Rig', bait: 'Sweetcorn, Dough Balls', count: 0 },
    { name: 'Northern Sunfish', rig: 'Bobber Rig', bait: 'Worms, Insects', count: 0 },
    { name: 'Muskellunge (Muskie)', rig: 'Large Crankbait Rig, Jig', bait: 'Large Minnows, Topwater Lures', count: 0 },
    { name: 'Yellow Bullhead', rig: 'Slip Sinker Rig', bait: 'Worms, Cut Bait', count: 0 },
    { name: 'White Perch (White Bass)', rig: 'Spinnerbait, Jig', bait: 'Minnows', count: 0 },
    { name: 'Freshwater Drum', rig: 'Bottom Rig', bait: 'Worms, Small Fish', count: 0 },
    { name: 'Rainbow Smelt', rig: 'Small Jig', bait: 'Small Minnows or Flies', count: 0 },
    { name: 'Chain Pickerel', rig: 'Spinnerbait, Jig', bait: 'Minnows, Frogs', count: 0 },
    { name: 'Cisco (Lake Herring)', rig: 'Jigging Spoon', bait: 'Minnows', count: 0 },
    { name: 'Mooneye', rig: 'Fly Rig', bait: 'Small Insects, Flies', count: 0 },
    { name: 'American Eel', rig: 'Bottom Rig', bait: 'Worms, Cut Bait', count: 0 },
    { name: 'Longnose Gar', rig: 'Rope Lure', bait: 'Minnows, Live Bait', count: 0 },
    { name: 'Round Goby', rig: 'Bottom Jig', bait: 'Worms, Soft Plastics', count: 0 },
    { name: 'Spottail Shiner', rig: 'Micro Jig', bait: 'Bread, Small Insects', count: 0 },
    { name: 'Golden Shiner', rig: 'Micro Hook Rig', bait: 'Dough Balls, Worms', count: 0 }
  ];

  // Load from localStorage
  const savedFish = JSON.parse(localStorage.getItem("fishTallies"));
  if (savedFish) {
    fishData.forEach((f, i) => f.count = savedFish[i]?.count || 0);
  }

  // Render List
  function renderFishList() {
    const list = document.getElementById("fishList");
    list.innerHTML = "";

    fishData.forEach((fish, index) => {
      const item = document.createElement("div");
      item.className = "fish-item";

      const name = document.createElement("div");
      name.className = "fish-name";
      name.textContent = fish.name;
      name.addEventListener("click", () => {
        const tips = document.getElementById(`fish-tips-${index}`);
        tips.style.display = tips.style.display === "block" ? "none" : "block";
      });

      const countRow = document.createElement("div");
      countRow.className = "fish-counter";

      const minus = document.createElement("button");
      minus.textContent = "âˆ’";
      minus.addEventListener("click", () => updateCount(index, -1));

      const count = document.createElement("span");
      count.id = `count-${index}`;
      count.textContent = fish.count;

      const plus = document.createElement("button");
      plus.textContent = "+";
      plus.addEventListener("click", () => updateCount(index, 1));

      countRow.appendChild(minus);
      countRow.appendChild(count);
      countRow.appendChild(plus);

      const tips = document.createElement("div");
      tips.className = "fish-tips";
      tips.id = `fish-tips-${index}`;
      tips.innerHTML = `
        <strong>Rig:</strong> ${fish.rig}<br>
        <strong>Bait:</strong> ${fish.bait}
      `;
      tips.style.display = "none";

      item.appendChild(name);
      item.appendChild(countRow);
      item.appendChild(tips);
      list.appendChild(item);
    });

    updateTotalFishCount();
  }

  // Update and save
  function updateCount(index, delta) {
    fishData[index].count = Math.max(0, fishData[index].count + delta);
    document.getElementById(`count-${index}`).textContent = fishData[index].count;
    localStorage.setItem("fishTallies", JSON.stringify(fishData));
    updateTotalFishCount();
  }

  function updateTotalFishCount() {
    let total = 0;
    document.querySelectorAll('.fish-counter span').forEach(span => {
      total += parseInt(span.textContent, 10);
    });
    document.getElementById('totalFishCount').textContent = total;
  }

  // Clear button
  function clearFishTallies() {
    if (!confirm("Clear all tallies?")) return;
    fishData.forEach(f => f.count = 0);
    localStorage.setItem("fishTallies", JSON.stringify(fishData));
    renderFishList();
  }

  // Init function
  function initFishList() {
    renderFishList();
    const clearBtn = document.getElementById("clearTallies");
    if (clearBtn) {
      clearBtn.addEventListener("click", clearFishTallies);
    }
  }

  function updateMapTiles(isDarkMode) {
  if (!window.myMap) return;

  if (isDarkMode) {
    if (window.myMap.hasLayer(lightTiles)) {
      window.myMap.removeLayer(lightTiles);
    }
    if (!window.myMap.hasLayer(darkTiles)) {
      darkTiles.addTo(window.myMap);
    }
  } else {
    if (window.myMap.hasLayer(darkTiles)) {
      window.myMap.removeLayer(darkTiles);
    }
    if (!window.myMap.hasLayer(lightTiles)) {
      lightTiles.addTo(window.myMap);
    }
  }
}
        
  // ===== Map Tile Layers (define first!) =====
let lightTiles, darkTiles;

if (typeof L !== "undefined") {
  lightTiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap contributors'
  });

  darkTiles = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
    maxZoom: 19,
    attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>'
  });
}

// ===== Map Theme Switcher =====
function updateMapTiles(isDarkMode) {
  if (!window.myMap) return;

  if (isDarkMode) {
    if (window.myMap.hasLayer(lightTiles)) {
      window.myMap.removeLayer(lightTiles);
    }
    if (!window.myMap.hasLayer(darkTiles)) {
      darkTiles.addTo(window.myMap);
    }
  } else {
    if (window.myMap.hasLayer(darkTiles)) {
      window.myMap.removeLayer(darkTiles);
    }
    if (!window.myMap.hasLayer(lightTiles)) {
      lightTiles.addTo(window.myMap);
    }
  }
}

  function zoomToUserLocation() {
  if (!window.myMap) return;

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const userLatLng = [position.coords.latitude, position.coords.longitude];
        window.myMap.setView(userLatLng, 15); // Adjust zoom level as needed

        // Optional: add a marker at user location
        L.marker(userLatLng)
          .addTo(window.myMap)
          .bindPopup('You are here')
          .openPopup();
      },
      (error) => {
        console.error('Geolocation error:', error.message);
      }
    );
  } else {
    console.error('Geolocation not supported');
  }
}

// ===== Main Window Load =====
window.onload = async function () {
  try {
    initFishList();
    setupTabs();
    await renderPhotoPosts();

    // === Dark Mode Toggle ===
    const darkToggle = document.getElementById("darkModeToggle");
    if (darkToggle) {
      const prefersDark = localStorage.getItem("darkMode") === "true";

      if (prefersDark) {
        document.body.classList.add("dark-mode");
        document.documentElement.classList.add("dark-mode");
      }

      darkToggle.textContent = prefersDark ? "â˜€ï¸ Day Time" : "ðŸŒ™ Night Time";
      updateMapTiles(prefersDark);

      darkToggle.addEventListener("click", () => {
        const isDark = document.body.classList.toggle("dark-mode");
        document.documentElement.classList.toggle("dark-mode", isDark);
        localStorage.setItem("darkMode", isDark);
        darkToggle.textContent = isDark ? "â˜€ï¸ Day Time" : "ðŸŒ™ Night Time";
        updateMapTiles(isDark);
      });
    }

    // === Export Method Toggle ===
    const exportToggle = document.getElementById("exportToggle");
    if (exportToggle) {
      // Load saved preference or fallback to true (Whammy)
      let saved = localStorage.getItem("useWhammy");
      useWhammy = saved === null ? true : saved === "true";

      // Set initial button text based on current flag
      exportToggle.textContent = useWhammy ? "Export: WebM" : "Export: GIF";

      // Toggle export method on button click
      exportToggle.addEventListener("click", () => {
        useWhammy = !useWhammy;
        localStorage.setItem("useWhammy", useWhammy);
        exportToggle.textContent = useWhammy ? "Export: WebM" : "Export: GIF";
      });
    }

    // === Upload Button ===
    const uploadBtn = document.getElementById("uploadButton");
    if (uploadBtn) {
      uploadBtn.addEventListener("click", handleUpload);
    }

    // === Modal Close Buttons ===
    const modalClose = document.getElementById("modalClose");
    if (modalClose) modalClose.addEventListener("click", closeModal);

    const closeInstagramModalBtn = document.getElementById("closeInstagramModal");
    if (closeInstagramModalBtn) {
      closeInstagramModalBtn.addEventListener("click", () => {
        document.getElementById("instagramModal").style.display = "none";
      });
    }

    window.addEventListener("keydown", e => {
      if (e.key === "Escape") closeModal();
    });

    // === Map Initialization ===
    if (typeof L !== "undefined") {
      window.myMap = L.map('map');
      lightTiles.addTo(window.myMap); // Add default tile set
      zoomToUserLocation(); // Call after initializing the map
    }

  } catch (err) {
    console.error("Initialization failed:", err);
  }
};
        
  // Service worker registration
  if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      // Unregister any existing service workers
      const registrations = await navigator.serviceWorker.getRegistrations();
      for (const registration of registrations) {
        await registration.unregister();
        console.log('Old service worker unregistered:', registration);
      }

      // Register the new service worker
      const reg = await navigator.serviceWorker.register('./sw.js');
      console.log('SW registered:', reg.scope);
    } catch (err) {
      console.error('Service Worker error:', err);
    }
  });
}
</script>

</body>
</html>
