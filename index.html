<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<meta name="theme-color" content="#000000" />
<title>Fishin' Buddy</title>

<style>
  body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: 'Segoe UI', sans-serif;
    background: #f2eee3; /* cork-like background */
    display: flex;
    flex-direction: column;
    color: #1b3c1a; /* dark green text */
  }

  header {
    background: #1b3c1a; /* forest green */
    color: #f7f2e3;
    padding: 1rem;
    font-weight: bold;
    text-align: center;
    font-size: 1.4rem;
    border-bottom: 4px solid #926c46; /* dark wood trim */
  }

  #tabs {
    display: flex;
    background: #2c4b1b; /* deeper forest green */
    flex-shrink: 0;
  }

  #tabs button {
    flex: 1;
    padding: 1rem;
    border: none;
    background: #d7c7a3; /* corky tab background */
    color: #1b3c1a;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  #tabs button.active {
    background: #1b3c1a; /* forest green */
    color: #fefae0;
  }

  section {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    background: #f2eee3;
  }

  .button {
  background-color: #4b2e1e; /* dark wood tone */
  color: #fff;
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  font-family: 'Verdana', sans-serif;
  box-shadow: inset 0 0 2px #000, 2px 2px 5px rgba(0, 0, 0, 0.4);
  cursor: pointer;
  transition: transform 0.1s, box-shadow 0.1s;
}
.button:hover {
  background-color: #5a3a29;
  transform: scale(1.02);
}
.button:active {
  box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.6);
  transform: scale(0.98);
}

  /* Memories feed container */
  #photoGallery {
    max-width: 420px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .catch-card {
    background: #fff8f0;
    border-radius: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    overflow: hidden;
    max-width: 420px;
  }

  .catch-photo {
    width: 100%;
    display: block;
    cursor: pointer;
  }

  .catch-info {
    padding: 0.5rem 1rem 1rem;
  }

  .catch-caption {
    font-weight: 600;
    margin: 0.2rem 0;
  }

  .catch-weight {
  font-weight: bold;
  color: #333;
}

  .catch-location, .catch-date {
    font-size: 0.9rem;
    color: #3a3a3a;
    margin: 0.1rem 0;
  }

  .catch-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
  }

  .catch-buttons button {
    background: #4b2e1a; /* dark wood brown */
    border: none;
    color: #fdf7ee;
    padding: 0.35rem 0.8rem;
    border-radius: 6px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .catch-buttons button:hover {
    background: #60391f;
  }

  #photoInput {
    display: block;
    margin: 0 auto 1rem;
  }

  #imageModal, #instagramModal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    justify-content: center;
    align-items: center;
    z-index: 10000;
  }

  #imageModal img {
    max-width: 90vw;
    max-height: 90vh;
    border-radius: 8px;
    box-shadow: 0 0 10px #000;
  }

  .modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    font-size: 2rem;
    color: white;
    cursor: pointer;
    user-select: none;
  }

  #talliesTab h3 {
    text-align: center;
    color: #1b3c1a;
  }

  .fish-list {
    padding: 1rem;
  }

  .fish-item {
    background: #fff3dd;
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transition: transform 0.15s ease;
  }

  .fish-item:hover {
    transform: scale(1.01);
  }

  .fish-name {
    font-weight: bold;
    font-size: 1.1rem;
    cursor: pointer;
    padding-bottom: 4px;
    border-bottom: 1px solid #aaa;
    margin-bottom: 6px;
  }

  .fish-counter {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 6px 0;
  }

  .fish-counter button {
    background: #4b2e1a;
    color: white;
    border: none;
    padding: 6px 12px;
    font-size: 1.2rem;
    border-radius: 6px;
    cursor: pointer;
  }

  .fish-counter button:hover {
    background: #60391f;
  }

  .fish-counter span {
    font-size: 1.3rem;
    min-width: 30px;
    text-align: center;
  }

  .fish-tips {
    margin-top: 6px;
    font-size: 0.95rem;
    color: #333;
    display: none;
  }

  .clear-btn {
    display: block;
    margin: 10px auto;
    padding: 8px 18px;
    background: #dc2626;
    color: white;
    font-size: 1rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }

  .clear-btn:hover {
    background: #b91c1c;
  }

  #memoriesTab, #talliesTab, #mapTab{
  display: none;
  height: 100%;
  flex: 1;
}

#memoriesTab.active, #talliesTab.active, #mapTab.active {
  display: block;
  height: 100%;
  flex: 1;
}

  .form-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: left;
  width: 100%;
}

.form-fields {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 1rem;
  max-width: 400px;
  width: 100%;
}

.form-fields label {
  width: 100%;
  font-weight: bold;
}

.form-fields input[type="text"] {
  width: 100%;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 1rem;
}

.form-fields button {
  align-self: center;
}

  #mapContainer {
  height: 100%;
  min-height: 400px;
  width: 100%;
  border-radius: 8px;
}

  /* === Night at the Lake: Dark Mode === */
body.dark-mode, html.dark-mode {
  background: #0d1b1e; /* deep night lake blue */
  color: #cce3dc; /* moonlight mist */
}

header.dark-mode {
  background: #0f2f2f;
  color: #cce3dc;
  border-bottom: 4px solid #5e3c1f; /* warm ember tone */
}

.dark-mode #tabs {
  background: #1a2c2c; /* deeper midnight green */
}

.dark-mode #tabs button {
  background: #2c2f2a; /* soft moss */
  color: #cce3dc;
}

.dark-mode #tabs button.active {
  background: #0f2f2f;
  color: #fefae0;
}

.dark-mode section {
  background: #0d1b1e;
  color: #e0f7fa;
}

.dark-mode .button {
  background-color: #5e3c1f; /* warm firewood */
  color: #fff;
  box-shadow: inset 0 0 2px #000, 2px 2px 5px rgba(255, 140, 0, 0.4);
}
.dark-mode .button:hover {
  background-color: #7a5233;
}

.dark-mode .catch-card {
  background: #1e2b2e; /* soft twilight */
  border: 1px solid #304f4f;
  color: #e0f7fa;
}

.dark-mode .catch-caption,
.dark-mode .catch-weight {
  color: #ffddaf; /* soft amber */
}

.dark-mode .catch-location,
.dark-mode .catch-date {
  color: #d5e4e2;
}

.dark-mode .catch-buttons button {
  background: #3f2c1f; /* charred wood */
  color: #fdf7ee;
}
.dark-mode .catch-buttons button:hover {
  background: #553c2a;
}

.dark-mode .fish-item {
  background: #263434; /* pondside moss */
  color: #e0f7fa;
  border: 1px solid #3a4c4c;
}

.dark-mode .fish-name {
  border-color: #888;
}

.dark-mode .fish-counter button {
  background: #5e3c1f;
}
.dark-mode .fish-counter button:hover {
  background: #7a5233;
}

.dark-mode .fish-tips {
  color: #c0dcdc;
}

.dark-mode .clear-btn {
  background: #8b1e1e;
}
.dark-mode .clear-btn:hover {
  background: #aa2a2a;
}

.dark-mode #imageModal,
.dark-mode #instagramModal {
  background: rgba(0, 0, 0, 0.9);
}

.dark-mode #talliesTab h3 {
  color: #cce3dc;
}

  #darkModeToggle {
  position: absolute;
  top: 1rem;
  right: 1rem;
  z-index: 100;
}

  .dark-mode .form-fields input[type="text"] {
  background: #1a2c2c;
  color: #e0f7fa;
  border: 1px solid #4a6464;
}
</style>
</head>
<body>

<header>Fishin' Buddy</header>
  <button id="darkModeToggle" class="button" style="margin: 1rem;">🌙 Dark Mode</button>

<div id="tabs">
  <button id="memoriesTabBtn" class="active">Memories</button>
  <button id="talliesTabBtn">Tallies</button>
  <button id="mapTabBtn">Map</button>
</div>

<!-- Memories Tab -->
<section id="memoriesTab" class="tab active">
  <div class="form-wrapper">
  <input type="file" id="photoInput" class="button" accept="image/*" multiple style="margin-bottom: 1rem;" />

  <div class="form-fields">
    <label for="captionInput">Caption:
      <input type="text" id="captionInput" placeholder="Enter caption here" />
    </label>

    <label for="locationInput">Location:
      <input type="text" id="locationInput" placeholder="Enter location here" />
    </label>

    <label for="weightInput">Weight (lbs):
      <input type="text" id="weightInput" placeholder="e.g. 2.5" />
    </label>

    <button id="uploadButton" class="button">Upload Photos</button>
  </div>

  <div id="photoGallery" aria-live="polite" aria-label="Memories photo feed" style="margin-top: 20px; width: 100%; max-width: 600px;"></div>
</div>
</section>

<!-- Tallies Tab -->
<section id="talliesTab" class="tab">
  <h3>Fish List</h3>
  <p style="font-size: 0.9em; margin-top: -10px; margin-bottom: 15px; text-align: center;">
    Bonus Tip: Tap the name of a fish to see its recommended rig and bait combos!
  </p>
  <h3>Total Fish Caught: <span id="totalFishCount">0</span></h3>
  <div id="fishList" class="fish-list"></div>
  <button id="clearTallies" class="clear-btn">Clear</button>
</section>

  <section id="mapTab" class="tab">
  <div id="map" style="height: 100%; width: 100%; min-height: 500px;"></div>
</section>

<!-- Fullscreen photo modal -->
<div id="imageModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <span id="modalClose" class="modal-close" aria-label="Close modal">&times;</span>
  <img id="modalImg" alt="Full size catch photo" />
</div>

<!-- Instagram sharing modal (simple confirmation) -->
<div id="instagramModal" role="alertdialog" aria-modal="true">
  <span id="closeInstagramModal" class="modal-close" aria-label="Close message">&times;</span>
  <div style="color:white; font-size:1.5em; background:#2563eb; padding:20px; border-radius:10px; max-width:300px; margin:auto;">
    Catch card downloaded! Share it on Instagram! 📸
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>

  function setupTabs() {
  const memoriesTabBtn = document.getElementById("memoriesTabBtn");
  const talliesTabBtn = document.getElementById("talliesTabBtn");
  const mapTabBtn = document.getElementById("mapTabBtn"); // new

  const memoriesTab = document.getElementById("memoriesTab");
  const talliesTab = document.getElementById("talliesTab");
  const mapTab = document.getElementById("mapTab"); // new

  if (!memoriesTabBtn || !talliesTabBtn || !mapTabBtn || !memoriesTab || !talliesTab || !mapTab) {
    console.warn("One or more tab elements are missing.");
    return;
  }

  memoriesTabBtn.addEventListener("click", () => {
    memoriesTabBtn.classList.add("active");
    talliesTabBtn.classList.remove("active");
    mapTabBtn.classList.remove("active");

    memoriesTab.classList.add("active");
    talliesTab.classList.remove("active");
    mapTab.classList.remove("active");
  });

  talliesTabBtn.addEventListener("click", () => {
    talliesTabBtn.classList.add("active");
    memoriesTabBtn.classList.remove("active");
    mapTabBtn.classList.remove("active");

    talliesTab.classList.add("active");
    memoriesTab.classList.remove("active");
    mapTab.classList.remove("active");
  });

  mapTabBtn.addEventListener("click", () => {
    mapTabBtn.classList.add("active");
    memoriesTabBtn.classList.remove("active");
    talliesTabBtn.classList.remove("active");

    mapTab.classList.add("active");
    memoriesTab.classList.remove("active");
    talliesTab.classList.remove("active");

    // Fix Leaflet map rendering after tab is shown
    setTimeout(() => {
      if (window.myMap) {
        window.myMap.invalidateSize();
      }
    }, 200);
  });
}
  
  // === IndexedDB Setup ===
  function openDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('MemoriesDB', 1);
      request.onupgradeneeded = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains('photos')) {
          db.createObjectStore('photos', { keyPath: 'id', autoIncrement: true });
        }
      };
      request.onsuccess = e => resolve(e.target.result);
      request.onerror = e => reject(e.target.error);
    });
  }

  async function addPhotoToDB(photo) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction('photos', 'readwrite');
      const store = tx.objectStore('photos');
      const req = store.add(photo);
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function getAllPhotosFromDB() {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction('photos', 'readonly');
      const store = tx.objectStore('photos');
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function deletePhotoFromDB(id) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction('photos', 'readwrite');
      const store = tx.objectStore('photos');
      const req = store.delete(id);
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
  }

  // Read file as data URL helper
  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = e => reject(e);
      reader.readAsDataURL(file);
    });
  }

  async function handleUpload() {
  const input = document.getElementById("photoInput");
  const files = input.files;
  if (!files.length) {
    alert("Please select at least one photo to upload.");
    return;
  }

  const caption = document.getElementById("captionInput").value.trim();
  const location = document.getElementById("locationInput").value.trim();
  const weight = document.getElementById("weightInput").value.trim();

  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    if (!file.type.startsWith("image/")) continue;

    try {
      const dataURL = await readFileAsDataURL(file);
      const timestamp = new Date().toISOString();

      await addPhotoToDB({ src: dataURL, caption, location, weight, timestamp });
    } catch (error) {
      console.error("Failed to process file:", error);
    }
  }

  await renderPhotoPosts();

  // Clear inputs and file input
  input.value = '';
  document.getElementById("captionInput").value = '';
  document.getElementById("locationInput").value = '';
  document.getElementById("weightInput").value = '';
}

  async function renderPhotoPosts() {
  const gallery = document.getElementById("photoGallery");
  gallery.innerHTML = "";

  const photos = await getAllPhotosFromDB();

  // Newest first
  photos.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

  photos.forEach((photo) => {
    const card = document.createElement("div");
    card.className = "catch-card";

    const img = document.createElement("img");
    img.src = photo.src;
    img.alt = photo.caption || "Catch photo";
    img.className = "catch-photo";
    img.addEventListener("click", () => openModal(photo.src));
    card.appendChild(img);

    const info = document.createElement("div");
    info.className = "catch-info";

    if (photo.caption) {
      const caption = document.createElement("p");
      caption.className = "catch-caption";
      caption.textContent = photo.caption;
      info.appendChild(caption);
    }

    if (photo.location) {
      const location = document.createElement("p");
      location.className = "catch-location";
      location.textContent = "Location: " + photo.location;
      info.appendChild(location);
    }

    if (photo.timestamp) {
      const date = document.createElement("p");
      date.className = "catch-date";
      date.textContent = "Caught: " + new Date(photo.timestamp).toLocaleString();
      info.appendChild(date);
    }

    if (photo.weight) {
      const weight = document.createElement("p");
      weight.className = "catch-weight";
      weight.textContent = "Weight: " + photo.weight + " lbs";
      info.appendChild(weight);
    }

    card.appendChild(info);

    const buttonRow = document.createElement("div");
    buttonRow.className = "catch-buttons";

    // Delete button — updated for IndexedDB
    const deleteButton = document.createElement("button");
    deleteButton.textContent = "Delete";
    deleteButton.title = "Delete this photo";
    deleteButton.addEventListener("click", async () => {
      if (confirm("Are you sure you want to delete this photo?")) {
        await deletePhotoFromDB(photo.id);
        await renderPhotoPosts();
      }
    });
    buttonRow.appendChild(deleteButton);

    // Download/share button
    const shareButton = document.createElement("button");
    shareButton.textContent = "Download";
    shareButton.title = "Download Catch Card";

    shareButton.addEventListener("click", () => {
      const clone = card.cloneNode(true);
      clone.style.position = 'fixed';
      clone.style.top = '-10000px';
      clone.style.left = '0';
      clone.style.background = '#fff';
      document.body.appendChild(clone);

      const buttons = clone.querySelector(".catch-buttons");
      if (buttons) buttons.remove();

      html2canvas(clone).then(canvas => {
        const ctx = canvas.getContext("2d");
        const watermarkImg = new Image();
        watermarkImg.src = "/icon_192x192.png";

        watermarkImg.onload = () => {
          ctx.globalAlpha = 0.3;
          const size = 64;
          const padding = 10;

          // Always bottom-right corner of the canvas
          ctx.drawImage(
            watermarkImg,
            canvas.width - size - padding,
            canvas.height - size - padding,
            size,
            size
          );

          const link = document.createElement("a");
          link.download = `catch-card-${photo.id}.png`;
          link.href = canvas.toDataURL("image/png");
          link.click();

          openInstagramModal();
          clone.remove();
        };
      });
    });

    buttonRow.appendChild(shareButton);
    card.appendChild(buttonRow);

    gallery.appendChild(card);
  }); // closes forEach
} // ✅ closes renderPhotoPosts correctly

// ✅ Now openModal is correctly outside
function openModal(src) {
  const modal = document.getElementById("imageModal");
  const modalImg = document.getElementById("modalImg");
  modalImg.src = src;
  modal.style.display = "flex";
}

function closeModal() {
  const modal = document.getElementById("imageModal"); // also fix here
  modal.style.display = "none";
}

  const fishData = [
    { name: 'Largemouth Bass', rig: 'Texas Rig, Wacky Rig', bait: 'Plastic worms, Jigs, Crankbaits', count: 0 },
    { name: 'Smallmouth Bass', rig: 'Drop Shot', bait: 'Minnow', count: 0 },
    { name: 'Northern Pike', rig: 'Spinner Rig', bait: 'Crankbait', count: 0 },
    { name: 'Walleye', rig: 'Jig Head', bait: 'Nightcrawler', count: 0 },
    { name: 'Yellow Perch', rig: 'Slip Bobber', bait: 'Minnows', count: 0 },
    { name: 'Rainbow Trout', rig: 'Fly Rig', bait: 'Dry Fly', count: 0 },
    { name: 'Brook Trout', rig: 'Inline Spinner', bait: 'Salmon Eggs', count: 0 },
    { name: 'Lake Trout', rig: 'Downrigger', bait: 'Spoon', count: 0 },
    { name: 'Brown Trout', rig: 'Drift Rig', bait: 'Worm', count: 0 },
    { name: 'Black Crappie', rig: 'Light Jig', bait: 'Small Minnow', count: 0 },
    { name: 'White Crappie', rig: 'Micro Jig', bait: 'Grubs', count: 0 },
    { name: 'Pumpkinseed Sunfish', rig: 'Bobber Rig', bait: 'Worms', count: 0 },
    { name: 'Bluegill', rig: 'Bobber Rig', bait: 'Crickets, Worms', count: 0 },
    { name: 'Rock Bass', rig: 'Light Jig', bait: 'Minnows, Worms', count: 0 },
    { name: 'White Bass', rig: 'Spinnerbait', bait: 'Shad Imitation', count: 0 },
    { name: 'Channel Catfish', rig: 'Slip Sinker Rig', bait: 'Stinkbait, Chicken Liver', count: 0 },
    { name: 'Flathead Catfish', rig: 'Live Bait Rig', bait: 'Live Bluegill', count: 0 },
    { name: 'Blue Catfish', rig: 'Bottom Rig', bait: 'Cut Shad', count: 0 },
    { name: 'Burbot', rig: 'Glow Jig', bait: 'Cut Bait, Worms', count: 0 },
    { name: 'Bowfin', rig: 'Weedless Jig', bait: 'Live Bait, Frogs', count: 0 },
    { name: 'Carp', rig: 'Hair Rig', bait: 'Sweetcorn, Dough Balls', count: 0 },
    { name: 'Northern Sunfish', rig: 'Bobber Rig', bait: 'Worms, Insects', count: 0 },
    { name: 'Muskellunge (Muskie)', rig: 'Large Crankbait Rig, Jig', bait: 'Large Minnows, Topwater Lures', count: 0 },
    { name: 'Yellow Bullhead', rig: 'Slip Sinker Rig', bait: 'Worms, Cut Bait', count: 0 },
    { name: 'White Perch (White Bass)', rig: 'Spinnerbait, Jig', bait: 'Minnows', count: 0 },
    { name: 'Freshwater Drum', rig: 'Bottom Rig', bait: 'Worms, Small Fish', count: 0 },
    { name: 'Rainbow Smelt', rig: 'Small Jig', bait: 'Small Minnows or Flies', count: 0 },
    { name: 'Chain Pickerel', rig: 'Spinnerbait, Jig', bait: 'Minnows, Frogs', count: 0 },
    { name: 'Cisco (Lake Herring)', rig: 'Jigging Spoon', bait: 'Minnows', count: 0 },
    { name: 'Mooneye', rig: 'Fly Rig', bait: 'Small Insects, Flies', count: 0 },
    { name: 'American Eel', rig: 'Bottom Rig', bait: 'Worms, Cut Bait', count: 0 },
    { name: 'Longnose Gar', rig: 'Rope Lure', bait: 'Minnows, Live Bait', count: 0 },
    { name: 'Round Goby', rig: 'Bottom Jig', bait: 'Worms, Soft Plastics', count: 0 },
    { name: 'Spottail Shiner', rig: 'Micro Jig', bait: 'Bread, Small Insects', count: 0 },
    { name: 'Golden Shiner', rig: 'Micro Hook Rig', bait: 'Dough Balls, Worms', count: 0 }
  ];

  // Load from localStorage
  const savedFish = JSON.parse(localStorage.getItem("fishTallies"));
  if (savedFish) {
    fishData.forEach((f, i) => f.count = savedFish[i]?.count || 0);
  }

  // Render List
  function renderFishList() {
    const list = document.getElementById("fishList");
    list.innerHTML = "";

    fishData.forEach((fish, index) => {
      const item = document.createElement("div");
      item.className = "fish-item";

      const name = document.createElement("div");
      name.className = "fish-name";
      name.textContent = fish.name;
      name.addEventListener("click", () => {
        const tips = document.getElementById(`fish-tips-${index}`);
        tips.style.display = tips.style.display === "block" ? "none" : "block";
      });

      const countRow = document.createElement("div");
      countRow.className = "fish-counter";

      const minus = document.createElement("button");
      minus.textContent = "−";
      minus.addEventListener("click", () => updateCount(index, -1));

      const count = document.createElement("span");
      count.id = `count-${index}`;
      count.textContent = fish.count;

      const plus = document.createElement("button");
      plus.textContent = "+";
      plus.addEventListener("click", () => updateCount(index, 1));

      countRow.appendChild(minus);
      countRow.appendChild(count);
      countRow.appendChild(plus);

      const tips = document.createElement("div");
      tips.className = "fish-tips";
      tips.id = `fish-tips-${index}`;
      tips.innerHTML = `
        <strong>Rig:</strong> ${fish.rig}<br>
        <strong>Bait:</strong> ${fish.bait}
      `;
      tips.style.display = "none";

      item.appendChild(name);
      item.appendChild(countRow);
      item.appendChild(tips);
      list.appendChild(item);
    });

    updateTotalFishCount();
  }

  // Update and save
  function updateCount(index, delta) {
    fishData[index].count = Math.max(0, fishData[index].count + delta);
    document.getElementById(`count-${index}`).textContent = fishData[index].count;
    localStorage.setItem("fishTallies", JSON.stringify(fishData));
    updateTotalFishCount();
  }

  function updateTotalFishCount() {
    let total = 0;
    document.querySelectorAll('.fish-counter span').forEach(span => {
      total += parseInt(span.textContent, 10);
    });
    document.getElementById('totalFishCount').textContent = total;
  }

  // Clear button
  function clearFishTallies() {
    if (!confirm("Clear all tallies?")) return;
    fishData.forEach(f => f.count = 0);
    localStorage.setItem("fishTallies", JSON.stringify(fishData));
    renderFishList();
  }

  // Init function
  function initFishList() {
    renderFishList();
    const clearBtn = document.getElementById("clearTallies");
    if (clearBtn) {
      clearBtn.addEventListener("click", clearFishTallies);
    }
  }

  function updateMapTiles(isDarkMode) {
  if (!window.myMap) return;

  if (isDarkMode) {
    if (window.myMap.hasLayer(lightTiles)) {
      window.myMap.removeLayer(lightTiles);
    }
    if (!window.myMap.hasLayer(darkTiles)) {
      darkTiles.addTo(window.myMap);
    }
  } else {
    if (window.myMap.hasLayer(darkTiles)) {
      window.myMap.removeLayer(darkTiles);
    }
    if (!window.myMap.hasLayer(lightTiles)) {
      lightTiles.addTo(window.myMap);
    }
  }
}
        
  // ===== Map Tile Layers (define first!) =====
let lightTiles, darkTiles;

if (typeof L !== "undefined") {
  lightTiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '© OpenStreetMap contributors'
  });

  darkTiles = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
    maxZoom: 19,
    attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>'
  });
}

// ===== Map Theme Switcher =====
function updateMapTiles(isDarkMode) {
  if (!window.myMap) return;

  if (isDarkMode) {
    if (window.myMap.hasLayer(lightTiles)) {
      window.myMap.removeLayer(lightTiles);
    }
    if (!window.myMap.hasLayer(darkTiles)) {
      darkTiles.addTo(window.myMap);
    }
  } else {
    if (window.myMap.hasLayer(darkTiles)) {
      window.myMap.removeLayer(darkTiles);
    }
    if (!window.myMap.hasLayer(lightTiles)) {
      lightTiles.addTo(window.myMap);
    }
  }
}

// ===== Main Window Load =====
window.onload = async function () {
  try {
    initFishList();
    setupTabs();
    await renderPhotoPosts();

    // === Dark Mode ===
    const darkToggle = document.getElementById("darkModeToggle");
    if (darkToggle) {
      const prefersDark = localStorage.getItem("darkMode") === "true";
      if (prefersDark) {
        document.body.classList.add("dark-mode");
        document.documentElement.classList.add("dark-mode");
      }

      updateMapTiles(prefersDark); // works now because tile layers exist

      darkToggle.addEventListener("click", () => {
        const isDark = document.body.classList.toggle("dark-mode");
        document.documentElement.classList.toggle("dark-mode", isDark);
        localStorage.setItem("darkMode", isDark);
        darkToggle.textContent = isDark ? "☀️ Day Mode" : "🌙 Night Mode";

        updateMapTiles(isDark);
      });

      darkToggle.textContent = prefersDark ? "☀️ Day Mode" : "🌙 Night Mode";
    }

    // Upload handling
    const uploadBtn = document.getElementById("uploadButton");
    if (uploadBtn) {
      uploadBtn.addEventListener("click", handleUpload);
    }

    // Modal handling
    const modalClose = document.getElementById("modalClose");
    if (modalClose) modalClose.addEventListener("click", closeModal);

    const closeInstagramModalBtn = document.getElementById("closeInstagramModal");
    if (closeInstagramModalBtn) {
      closeInstagramModalBtn.addEventListener("click", () => {
        document.getElementById("instagramModal").style.display = "none";
      });
    }

    window.addEventListener("keydown", e => {
      if (e.key === "Escape") closeModal();
    });

    // ===== Map Initialization =====
    if (typeof L !== "undefined") {
      window.myMap = L.map("mapContainer").setView([0, 0], 2);
      lightTiles.addTo(window.myMap); // default on load

      window.myMap.locate({ setView: true, maxZoom: 15 });

      window.myMap.on("locationfound", e => {
        const radius = e.accuracy;
        L.marker(e.latlng).addTo(window.myMap)
          .bindPopup("You are within " + radius.toFixed(0) + " meters from this point").openPopup();
        L.circle(e.latlng, radius).addTo(window.myMap);
      });

      window.myMap.on("locationerror", e => {
        console.warn("Location error:", e.message);
      });
    }

  } catch (err) {
    console.error("Initialization failed:", err);
  }
};
        
  // Service worker registration
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('SW registered:', reg.scope))
        .catch(err => console.error('SW failed:', err));
    });
  }
</script>

</body>
</html>
